<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ è‡ªå‹•åˆ†äº«å›é¥‹æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .results.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .results.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .results.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        input[type="text"] {
            width: 300px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ è‡ªå‹•åˆ†äº«å›é¥‹åŠŸèƒ½æ¸¬è©¦</h1>
        <p>æ¸¬è©¦ç›´æ¥åˆ†äº«é€£çµçš„10%å›é¥‹æ©Ÿåˆ¶</p>
        
        <div class="test-section">
            <h3>ğŸ“‹ æ¸¬è©¦åƒæ•¸è¨­å®š</h3>
            <div class="form-group">
                <label>å¡ç‰‡ID:</label>
                <input type="text" id="cardId" placeholder="è¼¸å…¥æ¸¬è©¦ç”¨çš„å¡ç‰‡ID" value="67d1617d-1dbb-44ef-924c-856c1d201e83">
            </div>
            <div class="form-group">
                <label>ç”¨æˆ¶ID:</label>
                <input type="text" id="userId" placeholder="è¼¸å…¥æ¸¬è©¦ç”¨çš„ç”¨æˆ¶ID" value="test-user-123">
            </div>
            <div class="form-group">
                <label>å›é¥‹æ¯”ä¾‹(%):</label>
                <input type="text" id="rewardPercentage" placeholder="é è¨­10%" value="10">
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª APIæ¸¬è©¦</h3>
            <button onclick="testAutoShareReward()">æ¸¬è©¦è‡ªå‹•åˆ†äº«å›é¥‹</button>
            <button onclick="checkCardPoints()">æŸ¥è©¢ç•¶å‰é»æ•¸</button>
            <button onclick="testInvalidCard()">æ¸¬è©¦ç„¡æ•ˆå¡ç‰‡</button>
            <div id="apiResults" class="results"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”— æ¨¡æ“¬è‡ªå‹•åˆ†äº«é€£çµ</h3>
            <p>æ¸¬è©¦ä¸åŒçš„é€£çµæ ¼å¼ï¼š</p>
            <button onclick="simulateAutoShare('M01001', 'test-user-123')">æ¨¡æ“¬: pageId + userId</button>
            <button onclick="simulateAutoShare('M01001', null)">æ¨¡æ“¬: åªæœ‰pageId</button>
            <div id="linkResults" class="results"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š äº¤æ˜“è¨˜éŒ„æŸ¥è©¢</h3>
            <button onclick="getPointsHistory()">æŸ¥è©¢æœ€è¿‘äº¤æ˜“è¨˜éŒ„</button>
            <div id="historyResults" class="results"></div>
        </div>
    </div>

    <script>
        // æ¸¬è©¦è‡ªå‹•åˆ†äº«å›é¥‹API
        async function testAutoShareReward() {
            const cardId = document.getElementById('cardId').value.trim();
            const userId = document.getElementById('userId').value.trim();
            const rewardPercentage = parseFloat(document.getElementById('rewardPercentage').value) || 10;
            const results = document.getElementById('apiResults');
            
            if (!cardId) {
                results.className = 'results error';
                results.textContent = 'è«‹è¼¸å…¥å¡ç‰‡ID';
                return;
            }
            
            results.className = 'results info';
            results.textContent = 'ğŸ”„ æ¸¬è©¦ä¸­...';
            
            try {
                const response = await fetch('/api/cards/auto-share-reward', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cardId: cardId,
                        userId: userId || null,
                        rewardPercentage: rewardPercentage
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    results.className = 'results success';
                    results.textContent = `âœ… å›é¥‹æˆåŠŸï¼
                    
ğŸ¯ å›é¥‹è©³æƒ…:
â€¢ å¡ç‰‡æ¨™é¡Œ: ${result.cardTitle}
â€¢ å›é¥‹é‡‘é¡: ${result.rewardAmount} é»
â€¢ åŸå§‹é»æ•¸: ${result.oldPoints} é»
â€¢ æ–°é»æ•¸: ${result.newPoints} é»
â€¢ åˆ†äº«æœƒè©±ID: ${result.shareSessionId}

ğŸ“Š è¨ˆç®—æ–¹å¼: 10é» Ã— ${rewardPercentage}% = ${result.rewardAmount}é»`;
                } else {
                    results.className = 'results error';
                    results.textContent = `âŒ å›é¥‹å¤±æ•—: ${result.error}`;
                }
            } catch (error) {
                results.className = 'results error';
                results.textContent = `âŒ è«‹æ±‚å¤±æ•—: ${error.message}`;
            }
        }
        
        // æŸ¥è©¢å¡ç‰‡ç•¶å‰é»æ•¸
        async function checkCardPoints() {
            const cardId = document.getElementById('cardId').value.trim();
            const results = document.getElementById('apiResults');
            
            if (!cardId) {
                results.className = 'results error';
                results.textContent = 'è«‹è¼¸å…¥å¡ç‰‡ID';
                return;
            }
            
            results.className = 'results info';
            results.textContent = 'ğŸ”„ æŸ¥è©¢ä¸­...';
            
            try {
                const response = await fetch(`/api/cards/list?type=main&userId=test-user-123&limit=10`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const card = result.data.find(c => c.id === cardId);
                    if (card) {
                        results.className = 'results success';
                        results.textContent = `ğŸ“Š å¡ç‰‡è³‡è¨Š:
                        
â€¢ ID: ${card.id}
â€¢ æ¨™é¡Œ: ${card.main_title_1 || card.display_name || 'æœªè¨­å®š'}
â€¢ ç•¶å‰é»æ•¸: ${card.user_points || 0} é»
â€¢ ç€è¦½æ¬¡æ•¸: ${card.pageview || 0} æ¬¡
â€¢ å»ºç«‹æ™‚é–“: ${new Date(card.created_at).toLocaleString()}`;
                    } else {
                        results.className = 'results error';
                        results.textContent = 'âŒ æ‰¾ä¸åˆ°æŒ‡å®šçš„å¡ç‰‡';
                    }
                } else {
                    results.className = 'results error';
                    results.textContent = `âŒ æŸ¥è©¢å¤±æ•—: ${result.error}`;
                }
            } catch (error) {
                results.className = 'results error';
                results.textContent = `âŒ è«‹æ±‚å¤±æ•—: ${error.message}`;
            }
        }
        
        // æ¸¬è©¦ç„¡æ•ˆå¡ç‰‡
        async function testInvalidCard() {
            const results = document.getElementById('apiResults');
            
            results.className = 'results info';
            results.textContent = 'ğŸ”„ æ¸¬è©¦ç„¡æ•ˆå¡ç‰‡...';
            
            try {
                const response = await fetch('/api/cards/auto-share-reward', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cardId: 'invalid-card-id-12345',
                        userId: 'test-user',
                        rewardPercentage: 10
                    })
                });
                
                const result = await response.json();
                
                results.className = 'results error';
                results.textContent = `âŒ é æœŸçš„éŒ¯èª¤å›æ‡‰:
                
â€¢ æˆåŠŸ: ${result.success}
â€¢ éŒ¯èª¤è¨Šæ¯: ${result.error}
â€¢ HTTPç‹€æ…‹: ${response.status}

âœ… éŒ¯èª¤è™•ç†æ­£å¸¸ï¼`;
            } catch (error) {
                results.className = 'results error';
                results.textContent = `âŒ è«‹æ±‚å¤±æ•—: ${error.message}`;
            }
        }
        
        // æ¨¡æ“¬è‡ªå‹•åˆ†äº«é€£çµ
        function simulateAutoShare(pageId, userId) {
            const results = document.getElementById('linkResults');
            
            let url = `https://liff.line.me/YOUR_LIFF_ID?pageId=${pageId}`;
            if (userId) {
                url += `&userId=${userId}`;
            }
            
            results.className = 'results info';
            results.textContent = `ğŸ”— æ¨¡æ“¬è‡ªå‹•åˆ†äº«é€£çµ:

ğŸ“‹ é€£çµæ ¼å¼: ${url}

ğŸ¯ é æœŸæµç¨‹:
1. ç”¨æˆ¶é»æ“Šé€£çµ
2. LIFFåˆå§‹åŒ–ä¸¦ç™»å…¥
3. æ ¹æ“špageId${userId ? '+userId' : ''}æŸ¥è©¢å¡ç‰‡è³‡æ–™
4. è‡ªå‹•å•Ÿå‹•LINEåˆ†äº«é¸æ“‡å™¨
5. åˆ†äº«æˆåŠŸå¾Œè§¸ç™¼10%å›é¥‹
6. é¡¯ç¤ºå›é¥‹æˆåŠŸè¨Šæ¯
7. 3ç§’å¾Œè‡ªå‹•é—œé–‰é é¢

ğŸ’¡ æ¸¬è©¦æ–¹å¼:
å¯¦éš›éœ€è¦åœ¨LINE Appä¸­é–‹å•Ÿæ­¤é€£çµé€²è¡Œå®Œæ•´æ¸¬è©¦`;
        }
        
        // æŸ¥è©¢äº¤æ˜“è¨˜éŒ„
        async function getPointsHistory() {
            const results = document.getElementById('historyResults');
            
            results.className = 'results info';
            results.textContent = 'ğŸ”„ æŸ¥è©¢äº¤æ˜“è¨˜éŒ„...';
            
            try {
                const response = await fetch('/api/points-history?limit=10');
                const result = await response.json();
                
                if (result.success && result.data) {
                    results.className = 'results success';
                    let output = `ğŸ“Š æœ€è¿‘10ç­†äº¤æ˜“è¨˜éŒ„:\n\n`;
                    
                    result.data.forEach((tx, index) => {
                        const date = new Date(tx.created_at).toLocaleString();
                        const type = tx.transaction_type === 'reward_auto_share' ? 'è‡ªå‹•åˆ†äº«å›é¥‹' : 
                                   tx.transaction_type === 'deduction' ? 'åˆ†äº«æ‰£é»' : 
                                   tx.transaction_type.includes('reward') ? 'åˆ†äº«å›é¥‹' : tx.transaction_type;
                        
                        output += `${index + 1}. ${date}
   é¡å‹: ${type}
   é‡‘é¡: ${tx.amount > 0 ? '+' : ''}${tx.amount} é»
   é¤˜é¡: ${tx.balance_before} â†’ ${tx.balance_after}
   å¡ç‰‡: ${tx.card_type}
   ${tx.share_session_id ? `æœƒè©±: ${tx.share_session_id}` : ''}
   
`;
                    });
                    
                    results.textContent = output;
                } else {
                    results.className = 'results error';
                    results.textContent = `âŒ æŸ¥è©¢å¤±æ•—: ${result.error}`;
                }
            } catch (error) {
                results.className = 'results error';
                results.textContent = `âŒ è«‹æ±‚å¤±æ•—: ${error.message}`;
            }
        }
        
        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        window.onload = function() {
            console.log('ğŸ¯ è‡ªå‹•åˆ†äº«å›é¥‹æ¸¬è©¦é é¢å·²è¼‰å…¥');
        };
    </script>
</body>
</html> 