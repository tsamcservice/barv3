<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 快速編輯器系統 - MTEST</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/flex2html.css">
    <script src="js/flex2html.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5rem;
            color: #333;
            margin: 0;
        }
        
        .system-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        .quick-editor-system {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }
        .main-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .btn-primary {
            background: rgba(255,255,255,0.95);
            color: #667eea;
            padding: 12px 24px;
            border-radius: 12px;
            text-decoration: none;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transform: scale(1.05);
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            text-decoration: none;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        .share-platforms {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
        }
        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 1rem;
        }
        .platform-btn {
            padding: 8px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            transition: all 0.2s ease;
        }
        .platform-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .preview-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .feature-explanation {
            background: #e8f4ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        .admin-section {
            background: #fff5f5;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #dc3545;
        }
        .admin-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .admin-btn {
            background: #dc3545;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .admin-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
                 @media (max-width: 768px) {
             .main-buttons {
                 flex-direction: column;
                 align-items: center;
             }
             .btn-primary, .btn-secondary {
                 width: 100%;
                 max-width: 300px;
             }
         }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>🚀 快速編輯器系統</h1>
            <p style="color: #666; font-size: 18px; margin: 10px 0;">MTEST 專用版本 - 多平台分享架構</p>
        </div>

        <!-- 🚀 全新快速編輯器系統 -->
        <div class="quick-editor-system">
            <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: bold; text-align: center;">
                🚀 全新快速編輯器系統
            </h2>
            <p style="text-align: center; margin: 0 0 1.5rem 0; font-size: 14px; opacity: 0.9;">
                ⚡ 0.5秒載入 | 🎨 離線編輯 | 📱 多平台分享 | 🔐 安全授權
            </p>
            
                         <!-- 登入狀態提示 -->
             <div id="loginStatus" class="feature-explanation" style="background: rgba(255,255,255,0.1); color: white; margin-bottom: 1.5rem;">
                 <h3 style="margin: 0 0 10px 0; font-size: 16px;">📋 系統狀態</h3>
                 <div id="statusContent" style="font-size: 14px; line-height: 1.6;">
                     <p style="margin: 5px 0;">🔍 正在檢查登入狀態...</p>
                 </div>
             </div>
            
                         <!-- 主要入口按鈕 -->
             <div class="main-buttons">
                 <a href="#" onclick="smartEdit(); return false;" id="editBtn" class="btn-primary">
                     ⚡ 智能編輯
                 </a>
                 <a href="#" onclick="forceLogin(); return false;" class="btn-secondary">
                     👤 重新登入
                 </a>
             </div>
            
            <!-- 分享平台按鈕群 -->
            <div class="share-platforms">
                <h4 style="margin: 0 0 1rem 0; font-size: 14px; text-align: center; opacity: 0.9;">
                    📱 多平台分享系統
                </h4>
                <div class="platform-grid">
                    <a href="/line-auth-bridge.html" class="platform-btn" style="background: #00C300; color: white;">
                        📱 LINE授權
                    </a>
                    <a href="/share-email.html" class="platform-btn" style="background: #EA4335; color: white;">
                        📧 EMAIL分享
                    </a>
                    <a href="/share-facebook.html" class="platform-btn" style="background: #1877F2; color: white;">
                        📘 Facebook
                    </a>
                    <a href="/share-universal.html" class="platform-btn" style="background: #6C757D; color: white;">
                        🌐 其他平台
                    </a>
                </div>
            </div>
        </div>

        <!-- 即時預覽區 - 單一區塊 -->
        <div class="preview-container">
            <h2 style="margin: 0 0 20px 0; color: #333; text-align: center;">👀 即時預覽 - M01001會員卡</h2>
            <div id="flex2html" style="max-width: 400px; margin: 0 auto;"></div>
            <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #666;">
                <p>📋 這是資料庫中的 M01001 會員卡範例</p>
                <p>🎨 點擊「立即編輯」或「LINE登入」開始個人化編輯</p>
            </div>
        </div>
    </div>

    <script src="js/editor.js"></script>
    <script>
        // M01001 會員卡 JSON 資料
        const m01001CardData = {
            "type": "flex",
            "altText": "我在呈璽/呈璽",
            "contents": {
                "type": "bubble",
                "size": "mega",
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "image",
                            "size": "full",
                            "aspectRatio": "1:1",
                            "aspectMode": "cover",
                            "url": "https://barv3.vercel.app/uploads/vip/TS-B1.png"
                        },
                        {
                            "type": "image",
                            "url": "https://barv3.vercel.app/uploads/vip/APNG1.png",
                            "size": "full",
                            "aspectRatio": "1:1",
                            "animated": true,
                            "aspectMode": "cover",
                            "position": "absolute",
                            "action": {
                                "type": "uri",
                                "label": "action",
                                "uri": "https://secure.smore.com/n/td1qc"
                            }
                        },
                        {
                            "type": "box",
                            "width": "90px",
                            "layout": "horizontal",
                            "spacing": "none",
                            "contents": [
                                {
                                    "type": "box",
                                    "action": {
                                        "uri": "https://lihi3.cc/ZWV2u",
                                        "type": "uri",
                                        "label": "VIP會員號碼"
                                    },
                                    "layout": "vertical",
                                    "contents": [
                                        {
                                            "url": "https://barv3.vercel.app/uploads/vip/icon_calendar.png",
                                            "type": "image",
                                            "action": {
                                                "uri": "https://lihi3.cc/ZWV2u",
                                                "type": "uri",
                                                "label": "action"
                                            },
                                            "size": "35px"
                                        },
                                        {
                                            "type": "text",
                                            "text": "TSAMC",
                                            "size": "10px",
                                            "align": "center",
                                            "gravity": "center",
                                            "offsetTop": "30px",
                                            "position": "absolute",
                                            "offsetStart": "12px",
                                            "color": "#FFFFFF"
                                        }
                                    ],
                                    "cornerRadius": "30px",
                                    "backgroundColor": "#A4924A"
                                },
                                {
                                    "type": "box",
                                    "action": {
                                        "uri": "https://lihi.cc/jl7Pw",
                                        "type": "uri",
                                        "label": "愛心會員號碼"
                                    },
                                    "layout": "vertical",
                                    "contents": [
                                        {
                                            "url": "https://barv3.vercel.app/uploads/vip/loveicon.png",
                                            "type": "image",
                                            "action": {
                                                "uri": "https://lihi.cc/jl7Pw",
                                                "type": "uri",
                                                "label": "action"
                                            },
                                            "size": "32px"
                                        },
                                        {
                                            "type": "text",
                                            "size": "10px",
                                            "align": "center",
                                            "gravity": "center",
                                            "position": "absolute",
                                            "offsetTop": "30px",
                                            "offsetStart": "12px",
                                            "text": "0000",
                                            "color": "#FFFFFF"
                                        }
                                    ],
                                    "cornerRadius": "30px",
                                    "backgroundColor": "#d00308"
                                }
                            ],
                            "offsetTop": "250px",
                            "offsetStart": "10px",
                            "height": "45px",
                            "position": "absolute"
                        },
                        {
                            "size": "20px",
                            "text": "我在呈璽",
                            "type": "text",
                            "align": "center",
                            "color": "#000000",
                            "weight": "bold",
                            "margin": "md"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "我在呈璽，欣賞美好幸福！我在呈璽，喝茶喝咖啡很悠閒！！我不在呈璽，就是在前往呈璽的路上！！！",
                                    "wrap": true,
                                    "size": "16px",
                                    "margin": "sm",
                                    "color": "#000000"
                                }
                            ],
                            "paddingEnd": "65px",
                            "paddingStart": "5px",
                            "height": "95px"
                        },
                        {
                            "type": "box",
                            "width": "65px",
                            "layout": "vertical",
                            "spacing": "none",
                            "contents": [
                                {
                                    "type": "box",
                                    "action": {
                                        "uri": "https://secure.smore.com/n/td1qc",
                                        "type": "uri",
                                        "label": "action"
                                    },
                                    "layout": "vertical",
                                    "contents": [
                                        {
                                            "url": "https://barv3.vercel.app/uploads/vip/TS-LOGO.png",
                                            "type": "image",
                                            "action": {
                                                "uri": "https://secure.smore.com/n/td1qc",
                                                "type": "uri",
                                                "label": "官網"
                                            },
                                            "aspectRatio": "1:1",
                                            "aspectMode": "cover",
                                            "backgroundColor": "#E1E6E0"
                                        }
                                    ],
                                    "cornerRadius": "35px",
                                    "borderWidth": "semi-bold",
                                    "borderColor": "#a4924c"
                                },
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "contents": [
                                        {
                                            "type": "text",
                                            "size": "14px",
                                            "text": "呈璽",
                                            "style": "italic",
                                            "color": "#a4924c",
                                            "align": "center",
                                            "weight": "bold",
                                            "wrap": true,
                                            "margin": "none"
                                        }
                                    ],
                                    "paddingAll": "none",
                                    "cornerRadius": "none",
                                    "margin": "none",
                                    "spacing": "none"
                                }
                            ],
                            "position": "absolute",
                            "offsetEnd": "5px",
                            "margin": "md",
                            "offsetTop": "315px"
                        },
                        {
                            "type": "box",
                            "layout": "horizontal",
                            "contents": [
                                {
                                    "type": "button",
                                    "action": {
                                        "type": "uri",
                                        "label": "加呈璽好友",
                                        "uri": "https://lin.ee/JLLIBlP"
                                    },
                                    "color": "#a4924a",
                                    "style": "primary",
                                    "height": "sm",
                                    "offsetEnd": "1px"
                                },
                                {
                                    "type": "button",
                                    "action": {
                                        "type": "uri",
                                        "label": "分享給好友",
                                        "uri": "https://liff.line.me/2007327814-BdWpj70m?pageId=M01001"
                                    },
                                    "color": "#a4924b",
                                    "style": "primary",
                                    "height": "sm",
                                    "offsetStart": "1px"
                                }
                            ],
                            "margin": "md"
                        }
                    ],
                    "backgroundColor": "#E1E6E0",
                    "paddingAll": "10px"
                },
                "footer": {
                    "type": "box",
                    "layout": "horizontal",
                    "spacing": "none",
                    "contents": [
                        {
                            "type": "text",
                            "text": "呈璽元宇宙3D展覽館",
                            "wrap": true,
                            "color": "#00000050",
                            "align": "center",
                            "action": {
                                "type": "uri",
                                "label": "action",
                                "uri": "https://lihi3.cc/LY5qf"
                            },
                            "size": "sm",
                            "margin": "none"
                        }
                    ],
                    "backgroundColor": "#E1E6E0",
                    "height": "30px",
                    "margin": "none",
                    "paddingAll": "2px"
                },
                "styles": {
                    "footer": {
                        "separatorColor": "#000000",
                        "separator": true
                    }
                }
            }
        };

                 // 頁面載入時顯示 M01001 會員卡並檢查登入狀態
         window.onload = function() {
             flex2html('flex2html', m01001CardData);
             checkLoginStatus();
             
             // 監聽localStorage變化（當用戶從其他分頁登入時）
             window.addEventListener('storage', function(e) {
                 if (e.key === 'lineUserProfile' || e.key === 'lineAuthCompleted') {
                     checkLoginStatus();
                 }
             });
             
             // 檢查URL參數（從LINE授權回來）
             const urlParams = new URLSearchParams(window.location.search);
             if (urlParams.get('authSuccess')) {
                 setTimeout(checkLoginStatus, 500); // 延遲檢查以確保localStorage已更新
             }
         };
        
        // 智能編輯系統 - 加強登入狀態檢查
        function checkLoginStatus() {
            const lineProfile = localStorage.getItem('lineUserProfile');
            const authCompleted = localStorage.getItem('lineAuthCompleted');
            const statusContent = document.getElementById('statusContent');
            const editBtn = document.getElementById('editBtn');
            
            // 更嚴格的登入狀態檢查
            let isValidLogin = false;
            let userData = null;
            
            if (lineProfile && authCompleted) {
                try {
                    userData = JSON.parse(lineProfile);
                    // 檢查必要欄位和時效性（24小時內）
                    if (userData.userId && userData.displayName && userData.timestamp) {
                        const now = Date.now();
                        const loginTime = userData.timestamp;
                        const hoursPassed = (now - loginTime) / (1000 * 60 * 60);
                        
                        if (hoursPassed < 24) {
                            isValidLogin = true;
                        }
                    }
                } catch (e) {
                    console.error('Invalid lineProfile data:', e);
                    // 清理損壞的資料
                    localStorage.removeItem('lineUserProfile');
                    localStorage.removeItem('lineAuthCompleted');
                }
            }
            
            if (isValidLogin && userData) {
                // 已登入狀態
                statusContent.innerHTML = `
                    <p style="margin: 5px 0;">✅ <strong>已登入</strong> - 歡迎，${userData.displayName}！</p>
                    <p style="margin: 5px 0;">🎯 點擊「智能編輯」直接進入編輯器</p>
                    <p style="margin: 5px 0;">🔄 如需更新個資，請點擊「重新登入」</p>
                    <p style="margin: 3px 0; font-size: 12px; opacity: 0.8;">👤 LINE ID: ${userData.userId.substring(0, 8)}...</p>
                `;
                editBtn.innerHTML = '⚡ 智能編輯';
                editBtn.style.background = 'rgba(0,255,0,0.9)';
                editBtn.style.color = 'white';
            } else {
                // 未登入或登入已過期
                statusContent.innerHTML = `
                    <p style="margin: 5px 0;">❌ <strong>未登入</strong> - 尚未獲取LINE個人資料</p>
                    <p style="margin: 5px 0;">🎯 點擊「智能編輯」將引導您登入</p>
                    <p style="margin: 5px 0;">💡 登入後可享受個人化編輯體驗</p>
                    <p style="margin: 3px 0; font-size: 12px; opacity: 0.8;">🔧 <a href="#" onclick="clearLoginData(); checkLoginStatus(); return false;" style="color: #ffd700;">清除登入快取</a></p>
                `;
                editBtn.innerHTML = '⚡ 智能編輯';
                editBtn.style.background = 'rgba(255,193,7,0.9)';
                editBtn.style.color = '#000';
            }
        }
        
        // 清除登入資料的函數
        function clearLoginData() {
            localStorage.removeItem('lineUserProfile');
            localStorage.removeItem('lineAuthCompleted');
            alert('🧹 登入快取已清除！');
        }
        
        function smartEdit() {
            console.log('🚀 簡化智能編輯系統 - 直接跳轉到MTEST');
            
            // 更新按鈕狀態
            const editBtn = document.getElementById('editBtn');
            if (editBtn) {
                editBtn.innerHTML = '🔄 載入中...';
                editBtn.style.background = 'rgba(108,117,125,0.8)';
                editBtn.disabled = true;
            }
            
            // 直接跳轉到 mcard-mtest.html，讓它自己處理所有認證邏輯
            // 不再需要複雜的認證檢查和多重跳轉
            setTimeout(() => {
                window.location.href = '/mcard-mtest.html?source=mtest-index';
            }, 300);
        }
        
        function forceLogin() {
            console.log('🔄 簡化重新登入流程');
            
            // 清除舊的認證資料
            localStorage.removeItem('lineUserProfile');
            localStorage.removeItem('lineAuthCompleted');
            localStorage.removeItem('authTimestamp');
            
            // 更新登入狀態顯示
            checkLoginStatus();
            
            // 直接跳轉到MTEST，讓它處理重新登入
            setTimeout(() => {
                window.location.href = '/mcard-mtest.html?source=mtest-index&forceLogin=true';
            }, 500);
        }


    </script>
</body>
</html> 