<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 快速編輯器系統 - MTEST</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/flex2html.css">
    <script src="js/flex2html.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5rem;
            color: #333;
            margin: 0;
        }
        
        .system-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        .quick-editor-system {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }
        .main-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .btn-primary {
            background: rgba(255,255,255,0.95);
            color: #667eea;
            padding: 12px 24px;
            border-radius: 12px;
            text-decoration: none;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transform: scale(1.05);
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            text-decoration: none;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        .share-platforms {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
        }
        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 1rem;
        }
        .platform-btn {
            padding: 8px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            transition: all 0.2s ease;
        }
        .platform-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .preview-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .feature-explanation {
            background: #e8f4ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        .admin-section {
            background: #fff5f5;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #dc3545;
        }
        .admin-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .admin-btn {
            background: #dc3545;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .admin-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
                 @media (max-width: 768px) {
             .main-buttons {
                 flex-direction: column;
                 align-items: center;
             }
             .btn-primary, .btn-secondary {
                 width: 100%;
                 max-width: 300px;
             }
         }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>🚀 快速編輯器系統</h1>
            <p style="color: #666; font-size: 18px; margin: 10px 0;">MTEST 專用版本 - 多平台分享架構</p>
        </div>

        <!-- 🚀 全新快速編輯器系統 -->
        <div class="quick-editor-system">
            <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: bold; text-align: center;">
                🚀 全新快速編輯器系統
            </h2>
            <p style="text-align: center; margin: 0 0 1.5rem 0; font-size: 14px; opacity: 0.9;">
                ⚡ 0.5秒載入 | 🎨 離線編輯 | 📱 多平台分享 | 🔐 安全授權
            </p>
            
                         <!-- 登入狀態提示 -->
             <div id="loginStatus" class="feature-explanation" style="background: rgba(255,255,255,0.1); color: white; margin-bottom: 1.5rem;">
                 <h3 style="margin: 0 0 10px 0; font-size: 16px;">📋 系統狀態</h3>
                 <div id="statusContent" style="font-size: 14px; line-height: 1.6;">
                     <p style="margin: 5px 0;">🔍 正在檢查登入狀態...</p>
                 </div>
             </div>
            
                         <!-- 主要入口按鈕 -->
             <div class="main-buttons">
                 <a href="#" onclick="smartEdit(); return false;" id="editBtn" class="btn-primary">
                     ⚡ 智能編輯
                 </a>
                 <a href="#" onclick="forceLogin(); return false;" class="btn-secondary">
                     👤 重新登入
                 </a>
             </div>
            
            <!-- 🔧 移除分享平台按鈕群 - 根據需求2-2，MTEST-INDEX只有預覽和說明，不要分享按鈕 -->
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 12px; margin-top: 1rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 14px; text-align: center; opacity: 0.9;">
                    📋 功能說明
                </h4>
                <div style="text-align: center; color: rgba(255,255,255,0.9); font-size: 13px; line-height: 1.6;">
                    <p style="margin: 8px 0;">✅ 動態載入資料庫資料</p>
                    <p style="margin: 8px 0;">👤 自動應用LINE個人資料</p>
                    <p style="margin: 8px 0;">🎨 個人化卡片預覽</p>
                    <p style="margin: 8px 0;">📱 分享功能請使用智能編輯器</p>
                </div>
            </div>
        </div>

        <!-- 即時預覽區 - 單一區塊 -->
        <div class="preview-container">
            <h2 style="margin: 0 0 20px 0; color: #333; text-align: center;">👀 即時預覽 - M01001會員卡</h2>
            <div id="flex2html" style="max-width: 400px; margin: 0 auto;">
                <!-- 載入中顯示 -->
                <div id="loading-indicator" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 24px; margin-bottom: 10px;">🔄</div>
                    <div>正在載入卡片資料...</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #666;">
                <p id="preview-description">📋 正在從資料庫載入 M01001 會員卡資料</p>
                <p>🎨 點擊「智能編輯」或「重新登入」開始個人化編輯</p>
            </div>
        </div>
    </div>

    <script src="js/editor.js"></script>
    <script>
        // 🔧 修正：移除硬編碼，改為動態載入
        let m01001CardData = null;
        let isDataLoaded = false;
        
        // 🚀 從資料庫載入M01001卡片資料
        async function loadM01001CardData() {
            try {
                console.log('🔄 開始載入M01001卡片資料...');
                
                // 檢查是否有有效的LINE個人資料
                const lineProfile = getValidLineProfile();
                
                let apiUrl = '/api/cards?pageId=M01001';
                
                // 如果有LINE個人資料，優先載入個人化資料
                if (lineProfile && lineProfile.userId) {
                    console.log('👤 發現LINE個人資料，嘗試載入個人化卡片');
                    apiUrl += `&userId=${lineProfile.userId}`;
                }
                
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    const cardData = result.data[0];
                    console.log('✅ 成功載入卡片資料:', cardData);
                    
                    // 如果有LINE個人資料，且卡片資料中沒有個人化資料，進行個人化處理
                    if (lineProfile && lineProfile.userId && !cardData.line_user_id) {
                        console.log('🎨 應用LINE個人資料到預設卡片');
                        return personalizeCardData(cardData, lineProfile);
                    }
                    
                    // 轉換資料庫格式為flex_json格式
                    return convertToFlexJson(cardData);
                } else {
                    console.error('❌ 無法載入卡片資料:', result);
                    return null;
                }
                
            } catch (error) {
                console.error('❌ 載入卡片資料失敗:', error);
                return null;
            }
        }
        
        // 🎨 個人化卡片資料
        function personalizeCardData(cardData, lineProfile) {
            console.log('🎨 個人化卡片資料:', lineProfile);
            
            // 創建個人化的卡片資料
            const personalizedCard = {
                ...cardData,
                display_name: lineProfile.displayName || cardData.display_name,
                member_image_url: lineProfile.pictureUrl || cardData.member_image_url,
                line_user_id: lineProfile.userId
            };
            
            // 更新預覽說明
            const descriptionEl = document.getElementById('preview-description');
            if (descriptionEl) {
                descriptionEl.innerHTML = `👤 已載入您的個人化卡片 - 歡迎 ${lineProfile.displayName}！`;
            }
            
            return convertToFlexJson(personalizedCard);
        }
        
        // 🔄 轉換資料庫格式為flex_json格式
        function convertToFlexJson(cardData) {
            try {
                // 如果已經有flex_json，直接使用
                if (cardData.flex_json) {
                    return cardData.flex_json;
                }
                
                // 如果沒有flex_json，使用getMainBubble函數生成
                if (typeof getMainBubble === 'function') {
                    const bubbleData = getMainBubble({ ...cardData, page_id: 'M01001' });
                    return {
                        type: 'flex',
                        altText: cardData.card_alt_title || cardData.main_title_1 || '我在呈璽/呈璽',
                        contents: bubbleData
                    };
                }
                
                // 使用預設的卡片結構
                return getDefaultFlexJson(cardData);
                
            } catch (error) {
                console.error('❌ 轉換flex_json失敗:', error);
                return getDefaultFlexJson(cardData);
            }
        }
        
        // 🔧 取得有效的LINE個人資料
        function getValidLineProfile() {
            try {
                const storedProfile = localStorage.getItem('lineUserProfile');
                const authCompleted = localStorage.getItem('lineAuthCompleted');
                
                if (storedProfile && authCompleted) {
                    const profile = JSON.parse(storedProfile);
                    
                    // 檢查資料完整性和時效性（24小時內）
                    if (profile.userId && profile.displayName && profile.timestamp) {
                        const hoursPassed = (Date.now() - profile.timestamp) / (1000 * 60 * 60);
                        
                        if (hoursPassed < 24) {
                            return profile;
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('❌ 解析LINE個人資料失敗:', error);
                return null;
            }
        }
        
        // 🔧 預設的flex_json結構
        function getDefaultFlexJson(cardData) {
            return {
                "type": "flex",
                "altText": cardData.card_alt_title || cardData.main_title_1 || "我在呈璽/呈璽",
                "contents": {
                    "type": "bubble",
                    "size": "mega",
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "image",
                                "size": "full",
                                "aspectRatio": "1:1",
                                "aspectMode": "cover",
                                "url": cardData.main_image_url || "https://barv3.vercel.app/uploads/vip/TS-B1.png"
                            },
                            {
                                "type": "image",
                                "url": cardData.snow_image_url || "https://barv3.vercel.app/uploads/vip/APNG1.png",
                                "size": "full",
                                "aspectRatio": "1:1",
                                "animated": true,
                                "aspectMode": "cover",
                                "position": "absolute",
                                "action": {
                                    "type": "uri",
                                    "label": "action",
                                    "uri": cardData.main_image_link || "https://secure.smore.com/n/td1qc"
                                }
                            },
                            {
                                "size": "20px",
                                "text": cardData.display_name || "我在呈璽",
                                "type": "text",
                                "align": "center",
                                "color": cardData.name_color1 || "#000000",
                                "weight": "bold",
                                "margin": "md"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": cardData.main_title_2 || "我在呈璽，欣賞美好幸福！",
                                        "wrap": true,
                                        "size": "16px",
                                        "margin": "sm",
                                        "color": cardData.main_title_2_color || "#000000"
                                    }
                                ],
                                "paddingEnd": "65px",
                                "paddingStart": "5px",
                                "height": "95px"
                            },
                            {
                                "type": "box",
                                "layout": "horizontal",
                                "contents": [
                                    {
                                        "type": "button",
                                        "action": {
                                            "type": "uri",
                                            "label": cardData.button_1_text || "加呈璽好友",
                                            "uri": cardData.button_1_url || "https://lin.ee/JLLIBlP"
                                        },
                                        "color": cardData.button_1_color || "#a4924a",
                                        "style": "primary",
                                        "height": "sm"
                                    },
                                    {
                                        "type": "button",
                                        "action": {
                                            "type": "uri",
                                            "label": cardData.s_button_text || "分享給好友",
                                            "uri": cardData.s_button_url || "https://liff.line.me/2007327814-OoJBbnwP?pageId=M01001"
                                        },
                                        "color": cardData.s_button_color || "#a4924b",
                                        "style": "primary",
                                        "height": "sm"
                                    }
                                ],
                                "margin": "md"
                            }
                        ],
                        "backgroundColor": "#E1E6E0",
                        "paddingAll": "10px"
                    }
                }
            };
        }
        
        // 🔄 渲染卡片預覽
        async function renderCardPreview() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const flex2htmlDiv = document.getElementById('flex2html');
            
            try {
                // 載入卡片資料
                m01001CardData = await loadM01001CardData();
                
                if (m01001CardData) {
                    // 隱藏載入指示器
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                    
                    // 渲染卡片
                    if (typeof flex2html === 'function') {
                        flex2html('flex2html', m01001CardData);
                        console.log('✅ 卡片預覽渲染完成');
                    } else {
                        console.error('❌ flex2html函數未載入');
                        showError('渲染函數未載入');
                    }
                    
                    isDataLoaded = true;
                } else {
                    showError('載入卡片資料失敗');
                }
            } catch (error) {
                console.error('❌ 渲染卡片預覽失敗:', error);
                showError('渲染卡片預覽失敗');
            }
        }
        
        // 🔧 顯示錯誤訊息
        function showError(message) {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.innerHTML = `
                    <div style="color: #c62828; font-size: 16px;">❌ ${message}</div>
                    <button onclick="renderCardPreview()" style="
                        margin-top: 10px;
                        padding: 8px 16px;
                        background: #4caf50;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                    ">🔄 重新載入</button>
                `;
            }
        }

        // 頁面載入時渲染卡片並檢查登入狀態
        window.onload = function() {
            // 🔧 修正：改為動態載入
            renderCardPreview();
            checkLoginStatus();
            
            // 監聽localStorage變化（當用戶從其他分頁登入時）
            window.addEventListener('storage', function(e) {
                if (e.key === 'lineUserProfile' || e.key === 'lineAuthCompleted') {
                    checkLoginStatus();
                    // 重新渲染卡片以應用個人化資料
                    if (isDataLoaded) {
                        renderCardPreview();
                    }
                }
            });
            
            // 檢查URL參數（從LINE授權回來）
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('authSuccess')) {
                setTimeout(() => {
                    checkLoginStatus();
                    // 重新渲染卡片以應用個人化資料
                    renderCardPreview();
                }, 500);
            }
        };
        
        // 智能編輯系統 - 加強登入狀態檢查
        function checkLoginStatus() {
            const lineProfile = localStorage.getItem('lineUserProfile');
            const authCompleted = localStorage.getItem('lineAuthCompleted');
            const statusContent = document.getElementById('statusContent');
            const editBtn = document.getElementById('editBtn');
            
            // 更嚴格的登入狀態檢查
            let isValidLogin = false;
            let userData = null;
            
            if (lineProfile && authCompleted) {
                try {
                    userData = JSON.parse(lineProfile);
                    // 檢查必要欄位和時效性（24小時內）
                    if (userData.userId && userData.displayName && userData.timestamp) {
                        const now = Date.now();
                        const loginTime = userData.timestamp;
                        const hoursPassed = (now - loginTime) / (1000 * 60 * 60);
                        
                        if (hoursPassed < 24) {
                            isValidLogin = true;
                        }
                    }
                } catch (e) {
                    console.error('Invalid lineProfile data:', e);
                    // 清理損壞的資料
                    localStorage.removeItem('lineUserProfile');
                    localStorage.removeItem('lineAuthCompleted');
                }
            }
            
            if (isValidLogin && userData) {
                // 已登入狀態
                statusContent.innerHTML = `
                    <p style="margin: 5px 0;">✅ <strong>已登入</strong> - 歡迎，${userData.displayName}！</p>
                    <p style="margin: 5px 0;">🎯 點擊「智能編輯」直接進入編輯器</p>
                    <p style="margin: 5px 0;">🔄 如需更新個資，請點擊「重新登入」</p>
                    <p style="margin: 3px 0; font-size: 12px; opacity: 0.8;">👤 LINE ID: ${userData.userId.substring(0, 8)}...</p>
                `;
                editBtn.innerHTML = '⚡ 智能編輯';
                editBtn.style.background = 'rgba(0,255,0,0.9)';
                editBtn.style.color = 'white';
            } else {
                // 未登入或登入已過期
                statusContent.innerHTML = `
                    <p style="margin: 5px 0;">❌ <strong>未登入</strong> - 尚未獲取LINE個人資料</p>
                    <p style="margin: 5px 0;">🎯 點擊「智能編輯」將引導您登入</p>
                    <p style="margin: 5px 0;">💡 登入後可享受個人化編輯體驗</p>
                    <p style="margin: 3px 0; font-size: 12px; opacity: 0.8;">🔧 <a href="#" onclick="clearLoginData(); checkLoginStatus(); return false;" style="color: #ffd700;">清除登入快取</a></p>
                `;
                editBtn.innerHTML = '⚡ 智能編輯';
                editBtn.style.background = 'rgba(255,193,7,0.9)';
                editBtn.style.color = '#000';
            }
        }
        
        // 清除登入資料的函數
        function clearLoginData() {
            localStorage.removeItem('lineUserProfile');
            localStorage.removeItem('lineAuthCompleted');
            alert('🧹 登入快取已清除！');
        }
        
        function smartEdit() {
            console.log('🚀 簡化智能編輯系統 - 直接跳轉到MTEST');
            
            // 更新按鈕狀態
            const editBtn = document.getElementById('editBtn');
            if (editBtn) {
                editBtn.innerHTML = '🔄 載入中...';
                editBtn.style.background = 'rgba(108,117,125,0.8)';
                editBtn.disabled = true;
            }
            
            // 直接跳轉到 mcard-mtest.html，讓它自己處理所有認證邏輯
            // 不再需要複雜的認證檢查和多重跳轉
            setTimeout(() => {
                window.location.href = '/mcard-mtest.html?source=mtest-index';
            }, 300);
        }
        
        function forceLogin() {
            console.log('🔄 簡化重新登入流程');
            
            // 清除舊的認證資料
            localStorage.removeItem('lineUserProfile');
            localStorage.removeItem('lineAuthCompleted');
            localStorage.removeItem('authTimestamp');
            
            // 更新登入狀態顯示
            checkLoginStatus();
            
            // 直接跳轉到MTEST，讓它處理重新登入
            setTimeout(() => {
                window.location.href = '/mcard-mtest.html?source=mtest-index&forceLogin=true';
            }, 500);
        }


    </script>
</body>
</html> 