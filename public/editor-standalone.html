<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ å¿«é€Ÿå¡ç‰‡ç·¨è¼¯å™¨</title>
    <link rel="stylesheet" href="css/style.css?v=20250703">
    <script src="js/flex2html.min.js"></script>
    <!-- ä¸è¼‰å…¥LIFF SDKï¼Œå¯¦ç¾å¿«é€Ÿå•Ÿå‹• -->
    <style>
        /* å¿«é€Ÿç·¨è¼¯å™¨å°ˆç”¨æ¨£å¼ */
        .fast-editor {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .editor-panel {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-panel {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .speed-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .share-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
        }
        
        .share-button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .share-button.line {
            background: #00C300;
            color: white;
        }
        
        .share-button.email {
            background: #EA4335;
            color: white;
        }
        
        .share-button.facebook {
            background: #1877F2;
            color: white;
        }
        
        .share-button.others {
            background: #6C757D;
            color: white;
        }
        
        .share-button.secondary {
            background: #F8F9FA;
            color: #495057;
            border: 1px solid #DEE2E6;
            flex: 1;
        }
        
        .share-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .share-button:active {
            transform: translateY(0);
        }
        
        .performance-stats {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }
        
        @media (max-width: 768px) {
            .fast-editor {
                flex-direction: column;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- é€Ÿåº¦æŒ‡ç¤ºå™¨ -->
    <div class="speed-indicator">
        âš¡ å¿«é€Ÿæ¨¡å¼ | è¼‰å…¥æ™‚é–“: <span id="loadTime">è¨ˆç®—ä¸­...</span>
    </div>
    
    <!-- ä¸»è¦ç·¨è¼¯ä»‹é¢ -->
    <div class="fast-editor">
        <!-- ç·¨è¼¯é¢æ¿ -->
        <div class="editor-panel">
            <h2>ğŸ¨ å¡ç‰‡ç·¨è¼¯å™¨</h2>
            
            <div class="form-group">
                <label for="main_title_1">ä¸»æ¨™é¡Œ</label>
                <input type="text" id="main_title_1" placeholder="è«‹è¼¸å…¥ä¸»æ¨™é¡Œ">
            </div>
            
            <div class="form-group">
                <label for="main_title_2">å‰¯æ¨™é¡Œ</label>
                <input type="text" id="main_title_2" placeholder="è«‹è¼¸å…¥å‰¯æ¨™é¡Œ">
            </div>
            
            <div class="form-group">
                <label for="display_name">é¡¯ç¤ºåç¨±</label>
                <input type="text" id="display_name" placeholder="è«‹è¼¸å…¥é¡¯ç¤ºåç¨±">
            </div>
            
            <div class="form-group">
                <label for="main_image_url">ä¸»åœ–ç‰‡URL</label>
                <input type="url" id="main_image_url" placeholder="è«‹è¼¸å…¥åœ–ç‰‡URL">
            </div>
            
            <div class="form-group">
                <label for="member_image_url">æœƒå“¡åœ–ç‰‡URL</label>
                <input type="url" id="member_image_url" placeholder="è«‹è¼¸å…¥æœƒå“¡åœ–ç‰‡URL">
            </div>
            
            <div class="form-group">
                <label for="button_1_text">æŒ‰éˆ•æ–‡å­—</label>
                <input type="text" id="button_1_text" placeholder="è«‹è¼¸å…¥æŒ‰éˆ•æ–‡å­—">
            </div>
            
            <div class="form-group">
                <label for="button_1_url">æŒ‰éˆ•é€£çµ</label>
                <input type="url" id="button_1_url" placeholder="è«‹è¼¸å…¥æŒ‰éˆ•é€£çµ">
            </div>
            
            <!-- å¤šå¹³å°åˆ†äº«æŒ‰éˆ•å€åŸŸ -->
            <div class="share-buttons">
                <button class="share-button line" onclick="shareToLine()">
                    ğŸ“± åˆ†äº«åˆ°LINE
                </button>
                <button class="share-button email" onclick="shareToEmail()">
                    ğŸ“§ åˆ†äº«EMAIL
                </button>
                <button class="share-button facebook" onclick="shareToFacebook()">
                    ğŸ“˜ Facebook
                </button>
                <button class="share-button others" onclick="shareToOthers()">
                    ğŸŒ å…¶ä»–å¹³å°
                </button>
            </div>
            
            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="quick-actions" style="margin-top: 15px;">
                <button class="share-button secondary" onclick="saveCard()">
                    ğŸ’¾ å„²å­˜å¡ç‰‡
                </button>
                <button class="share-button secondary" onclick="copyCardData()">
                    ğŸ“‹ è¤‡è£½è³‡æ–™
                </button>
            </div>
            
            <!-- é€²éšåŠŸèƒ½ -->
            <details style="margin-top: 20px;">
                <summary>âš™ï¸ é€²éšè¨­å®š</summary>
                <div style="margin-top: 10px;">
                    <button onclick="importFromLine()" style="margin-right: 10px;">
                        ğŸ‘¤ ä½¿ç”¨LINEå€‹è³‡
                    </button>
                    <button onclick="exportCard()" style="margin-right: 10px;">
                        ğŸ“¤ åŒ¯å‡ºå¡ç‰‡
                    </button>
                    <button onclick="clearCache()">
                        ğŸ—‘ï¸ æ¸…é™¤å¿«å–
                    </button>
                </div>
            </details>
        </div>
        
        <!-- é è¦½é¢æ¿ -->
        <div class="preview-panel">
            <h2>ğŸ‘ï¸ å³æ™‚é è¦½</h2>
            <div id="preview-container">
                <div id="main-card-preview" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                    <div class="chatbox" id="preview-chatbox"></div>
                </div>
            </div>
            
            <!-- é è¦½æ§åˆ¶ -->
            <div style="margin-top: 15px;">
                <button onclick="refreshPreview()" style="margin-right: 10px;">
                    ğŸ”„ é‡æ–°æ•´ç†é è¦½
                </button>
                <button onclick="fullScreenPreview()">
                    ğŸ–¥ï¸ å…¨è¢å¹•é è¦½
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ•ˆèƒ½çµ±è¨ˆ -->
    <div class="performance-stats">
        <div>è¼‰å…¥æ™‚é–“: <span id="totalLoadTime">-</span>ms</div>
        <div>é è¦½æ›´æ–°: <span id="previewUpdateTime">-</span>ms</div>
        <div>å¿«å–å‘½ä¸­: <span id="cacheHits">-</span></div>
    </div>
    
    <script>
        // ğŸš€ å¿«é€Ÿç·¨è¼¯å™¨ä¸»ç¨‹å¼
        class FastEditor {
            constructor() {
                this.startTime = performance.now();
                this.previewUpdateCount = 0;
                this.cacheHits = 0;
                this.lineProfile = null;
                this.userCardData = null; // ğŸ†• ç”¨æˆ¶è³‡æ–™åº«è³‡æ–™
                this.defaultCard = {
                    main_title_1: 'æˆ‘åœ¨å‘ˆç’½',
                    main_title_2: 'æˆ‘åœ¨å‘ˆç’½ï¼Œæ¬£è³ç¾å¥½å¹¸ç¦ï¼',
                    display_name: 'å‘ˆç’½',
                    main_image_url: 'https://barv3.vercel.app/uploads/vip/TS-B1.png',
                    member_image_url: 'https://barv3.vercel.app/uploads/vip/TS-LOGO.png',
                    button_1_text: 'åŠ å‘ˆç’½å¥½å‹',
                    button_1_url: 'https://lin.ee/JLLIBlP'
                };
                
                this.init();
            }
            
            async init() {
                console.log('ğŸš€ åˆå§‹åŒ–å¿«é€Ÿç·¨è¼¯å™¨...');
                
                // 1. æª¢æŸ¥LINEå€‹è³‡ä¸¦è¼‰å…¥ç”¨æˆ¶è³‡æ–™
                await this.checkLineProfile();
                
                // 2. è¼‰å…¥é è¨­è³‡æ–™ï¼ˆæœƒè‡ªå‹•è™•ç†è³‡æ–™åº«è³‡æ–™ï¼‰
                this.loadDefaultData();
                
                // 3. ç¶å®šäº‹ä»¶
                this.bindEvents();
                
                // 4. ç«‹å³é è¦½
                this.updatePreview();
                
                // 5. è¼‰å…¥å®Œæˆ
                const loadTime = performance.now() - this.startTime;
                document.getElementById('loadTime').textContent = `${loadTime.toFixed(1)}ms`;
                document.getElementById('totalLoadTime').textContent = loadTime.toFixed(1);
                
                console.log(`âœ… å¿«é€Ÿç·¨è¼¯å™¨è¼‰å…¥å®Œæˆ: ${loadTime.toFixed(1)}ms`);
                
                // 6. é¡¯ç¤ºè¼‰å…¥çš„è³‡æ–™é¡å‹
                if (this.userCardData) {
                    console.log('ğŸ“Š å·²è¼‰å…¥ç”¨æˆ¶å€‹äººåŒ–è³‡æ–™åº«è³‡æ–™');
                } else if (this.lineProfile) {
                    console.log('ğŸ‘¤ å·²è¼‰å…¥LINEåŸºæœ¬å€‹è³‡');
                } else {
                    console.log('ğŸ“‹ ä½¿ç”¨é è¨­å¡ç‰‡è³‡æ–™');
                }
            }
            
            // ğŸ”§ æª¢æŸ¥ç”¨æˆ¶è³‡æ–™ï¼ˆLINEå€‹è³‡ + è³‡æ–™åº«è³‡æ–™ï¼‰
            async checkLineProfile() {
                // æª¢æŸ¥URLåƒæ•¸æ˜¯å¦æœ‰èªè­‰æˆåŠŸæ¨™è¨˜
                const urlParams = new URLSearchParams(window.location.search);
                const authSuccess = urlParams.get('authSuccess');
                
                if (authSuccess) {
                    console.log('âœ… å¾LINEæˆæ¬Šè¿”å›');
                    // æ¸…é™¤URLåƒæ•¸
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // æª¢æŸ¥localStorageä¸­çš„LINEå€‹è³‡
                const savedProfile = localStorage.getItem('lineUserProfile');
                if (savedProfile) {
                    try {
                        const profileData = JSON.parse(savedProfile);
                        
                        // æª¢æŸ¥è³‡æ–™æ˜¯å¦éæœŸï¼ˆ24å°æ™‚ï¼‰
                        const isExpired = Date.now() - profileData.timestamp > 24 * 60 * 60 * 1000;
                        
                        if (!isExpired) {
                            this.lineProfile = profileData;
                            console.log('âœ… è¼‰å…¥å¿«å–çš„LINEå€‹è³‡:', profileData.displayName);
                            
                            // ğŸ†• å˜—è©¦å¾è³‡æ–™åº«è¼‰å…¥ç”¨æˆ¶çš„å€‹äººåŒ–å¡ç‰‡
                            await this.loadUserCardFromDatabase(profileData.userId);
                            
                            this.showProfileStatus(profileData);
                            return;
                        } else {
                            console.log('âš ï¸ LINEå€‹è³‡å·²éæœŸï¼Œæ¸…é™¤å¿«å–');
                            localStorage.removeItem('lineUserProfile');
                        }
                    } catch (e) {
                        console.error('LINEå€‹è³‡è§£æå¤±æ•—:', e);
                        localStorage.removeItem('lineUserProfile');
                    }
                }
                
                // æ²’æœ‰æœ‰æ•ˆçš„LINEå€‹è³‡ï¼Œé¡¯ç¤ºæˆæ¬ŠæŒ‰éˆ•
                this.showAuthButton();
            }
            
            // ğŸ†• å¾è³‡æ–™åº«è¼‰å…¥ç”¨æˆ¶å¡ç‰‡è³‡æ–™
            async loadUserCardFromDatabase(userId) {
                try {
                    console.log('ğŸ” æŸ¥è©¢ç”¨æˆ¶è³‡æ–™åº«è³‡æ–™...', userId);
                    
                    const response = await fetch(`/api/cards?pageId=M01001&userId=${userId}`);
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.length > 0) {
                        const userCard = result.data[0];
                        console.log('âœ… æ‰¾åˆ°ç”¨æˆ¶è³‡æ–™åº«è³‡æ–™:', userCard);
                        
                        // è¨­ç½®ç”¨æˆ¶çš„å€‹äººåŒ–å¡ç‰‡è³‡æ–™
                        this.userCardData = userCard;
                        
                        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                        this.showDatabaseLoadStatus();
                        
                        return true;
                    } else {
                        console.log('âš ï¸ è³‡æ–™åº«ä¸­æœªæ‰¾åˆ°ç”¨æˆ¶å¡ç‰‡è³‡æ–™ï¼Œä½¿ç”¨LINEåŸºæœ¬å€‹è³‡');
                        return false;
                    }
                } catch (error) {
                    console.error('âŒ è³‡æ–™åº«æŸ¥è©¢å¤±æ•—:', error);
                    return false;
                }
            }
            
            // ğŸ†• é¡¯ç¤ºè³‡æ–™åº«è¼‰å…¥ç‹€æ…‹
            showDatabaseLoadStatus() {
                const speedIndicator = document.querySelector('.speed-indicator');
                if (this.lineProfile && this.userCardData) {
                    speedIndicator.innerHTML = `
                        <img src="${this.lineProfile.pictureUrl}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 5px;">
                        ${this.lineProfile.displayName} | ğŸ“Š å€‹äººåŒ–è³‡æ–™ | è¼‰å…¥æ™‚é–“: <span id="loadTime">è¨ˆç®—ä¸­...</span>
                    `;
                } else if (this.lineProfile) {
                    speedIndicator.innerHTML = `
                        <img src="${this.lineProfile.pictureUrl}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 5px;">
                        ${this.lineProfile.displayName} | ğŸ“‹ åŸºæœ¬è³‡æ–™ | è¼‰å…¥æ™‚é–“: <span id="loadTime">è¨ˆç®—ä¸­...</span>
                    `;
                }
            }
            
            // ğŸ”§ é¡¯ç¤ºå€‹è³‡ç‹€æ…‹
            showProfileStatus(profile) {
                // ä½¿ç”¨æ–°çš„è³‡æ–™åº«è¼‰å…¥ç‹€æ…‹é¡¯ç¤º
                this.showDatabaseLoadStatus();
                
                // åœ¨ç·¨è¼¯å™¨ä¸­æ·»åŠ é‡æ–°æˆæ¬ŠæŒ‰éˆ•
                this.addReauthButton();
            }
            
            // ğŸ”§ é¡¯ç¤ºæˆæ¬ŠæŒ‰éˆ•
            showAuthButton() {
                const speedIndicator = document.querySelector('.speed-indicator');
                speedIndicator.innerHTML = `
                    âš¡ å¿«é€Ÿæ¨¡å¼ | 
                    <button onclick="authorizeWithLine()" style="
                        background: white; 
                        color: #00B900; 
                        border: none; 
                        padding: 4px 8px; 
                        border-radius: 4px; 
                        cursor: pointer;
                        font-size: 10px;
                        margin-left: 5px;
                    ">ğŸ” LINEæˆæ¬Š</button>
                    | è¼‰å…¥æ™‚é–“: <span id="loadTime">è¨ˆç®—ä¸­...</span>
                `;
            }
            
            // ğŸ”§ æ·»åŠ é‡æ–°æˆæ¬ŠæŒ‰éˆ•
            addReauthButton() {
                const editorPanel = document.querySelector('.editor-panel');
                const existingBtn = document.getElementById('reauth-btn');
                
                if (!existingBtn) {
                    const reauthBtn = document.createElement('button');
                    reauthBtn.id = 'reauth-btn';
                    reauthBtn.innerHTML = 'ğŸ”„ é‡æ–°æˆæ¬ŠLINE';
                    reauthBtn.style.cssText = `
                        background: #00B900;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-top: 10px;
                        font-size: 12px;
                    `;
                    reauthBtn.onclick = () => authorizeWithLine();
                    
                    editorPanel.appendChild(reauthBtn);
                }
            }
            
            loadDefaultData() {
                // è³‡æ–™å„ªå…ˆé †åºï¼šç”¨æˆ¶è³‡æ–™åº«è³‡æ–™ > æœ¬åœ°å¿«å– > LINEå€‹è³‡ > é è¨­è³‡æ–™
                let cardData = this.defaultCard;
                
                // 1. æª¢æŸ¥æœ¬åœ°å¿«å–
                const cachedData = localStorage.getItem('fastEditor_cardData');
                if (cachedData) {
                    try {
                        cardData = { ...cardData, ...JSON.parse(cachedData) };
                        this.cacheHits++;
                        console.log('âœ… è¼‰å…¥æœ¬åœ°å¿«å–è³‡æ–™');
                    } catch (e) {
                        console.warn('æœ¬åœ°å¿«å–è§£æå¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™');
                    }
                }
                
                // 2. å¦‚æœæœ‰LINEå€‹è³‡ä½†ç„¡è³‡æ–™åº«è³‡æ–™ï¼Œä½¿ç”¨LINEåŸºæœ¬å€‹è³‡
                if (this.lineProfile && !this.userCardData) {
                    cardData = {
                        ...cardData,
                        display_name: this.lineProfile.displayName,
                        member_image_url: this.lineProfile.pictureUrl
                    };
                    console.log('âœ… ä½¿ç”¨LINEåŸºæœ¬å€‹è³‡å€‹äººåŒ–å¡ç‰‡');
                }
                
                // 3. ğŸ†• å¦‚æœæœ‰ç”¨æˆ¶è³‡æ–™åº«è³‡æ–™ï¼Œå„ªå…ˆä½¿ç”¨ï¼ˆæœ€é«˜å„ªå…ˆç´šï¼‰
                if (this.userCardData) {
                    // å°‡è³‡æ–™åº«è³‡æ–™æ˜ å°„åˆ°è¡¨å–®æ¬„ä½
                    const dbCardData = this.mapDatabaseToForm(this.userCardData);
                    cardData = { ...cardData, ...dbCardData };
                    console.log('âœ… ä½¿ç”¨ç”¨æˆ¶è³‡æ–™åº«å€‹äººåŒ–è³‡æ–™');
                }
                
                // å¡«å…¥è¡¨å–®
                Object.keys(cardData).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = cardData[key];
                    }
                });
                
                this.updateStats();
            }
            
            // ğŸ†• å°‡è³‡æ–™åº«è³‡æ–™æ˜ å°„åˆ°è¡¨å–®æ¬„ä½
            mapDatabaseToForm(dbData) {
                const formData = {};
                
                // åŸºæœ¬æ˜ å°„
                const fieldMappings = {
                    'main_title_1': dbData.main_title_1,
                    'main_title_2': dbData.main_title_2,
                    'display_name': dbData.display_name,
                    'main_image_url': dbData.main_image_url,
                    'member_image_url': dbData.member_image_url,
                    'button_1_text': dbData.button_1_text,
                    'button_1_url': dbData.button_1_url,
                    'snow_image_url': dbData.snow_image_url,
                    'calendar_image_url': dbData.calendar_image_url,
                    'love_icon_url': dbData.love_icon_url,
                    'main_title_1_color': dbData.main_title_1_color,
                    'main_title_2_color': dbData.main_title_2_color,
                    'name_color1': dbData.name_color1,
                    'button_1_color': dbData.button_1_color,
                    's_button_text': dbData.s_button_text,
                    's_button_color': dbData.s_button_color,
                    'card_alt_title': dbData.card_alt_title
                };
                
                // åªæ·»åŠ æœ‰å€¼çš„æ¬„ä½
                Object.keys(fieldMappings).forEach(key => {
                    if (fieldMappings[key] !== undefined && fieldMappings[key] !== null && fieldMappings[key] !== '') {
                        formData[key] = fieldMappings[key];
                    }
                });
                
                console.log('ğŸ”„ è³‡æ–™åº«è³‡æ–™æ˜ å°„å®Œæˆ:', Object.keys(formData).length, 'å€‹æ¬„ä½');
                return formData;
            }
            
            bindEvents() {
                // ç¶å®šæ‰€æœ‰è¼¸å…¥æ¬„ä½çš„å³æ™‚æ›´æ–°
                const inputs = document.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.updatePreview();
                        this.saveToCache();
                    });
                });
                
                // éµç›¤å¿«æ·éµ
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 's':
                                e.preventDefault();
                                this.saveCard();
                                break;
                            case 'Enter':
                                e.preventDefault();
                                this.shareToLine();
                                break;
                        }
                    }
                });
            }
            
            updatePreview() {
                const startTime = performance.now();
                
                const cardData = this.getFormData();
                const bubble = this.createBubble(cardData);
                
                const flexJson = {
                    type: 'flex',
                    altText: cardData.main_title_1 || 'æˆ‘çš„æœƒå“¡å¡',
                    contents: bubble
                };
                
                const chatbox = document.getElementById('preview-chatbox');
                chatbox.innerHTML = '';
                
                if (window.flex2html) {
                    flex2html('preview-chatbox', flexJson);
                }
                
                const updateTime = performance.now() - startTime;
                document.getElementById('previewUpdateTime').textContent = updateTime.toFixed(1);
                
                this.previewUpdateCount++;
                console.log(`ğŸ”„ é è¦½æ›´æ–° #${this.previewUpdateCount}: ${updateTime.toFixed(1)}ms`);
            }
            
            getFormData() {
                const formData = {};
                Object.keys(this.defaultCard).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        formData[key] = element.value || this.defaultCard[key];
                    } else {
                        formData[key] = this.defaultCard[key];
                    }
                });
                return formData;
            }
            
            createBubble(cardData) {
                return {
                    type: 'bubble',
                    hero: cardData.main_image_url ? {
                        type: 'image',
                        url: cardData.main_image_url,
                        size: 'full',
                        aspectRatio: '20:13',
                        aspectMode: 'cover'
                    } : undefined,
                    body: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'text',
                                text: cardData.main_title_1,
                                weight: 'bold',
                                size: 'xl',
                                color: '#333333'
                            },
                            {
                                type: 'text',
                                text: cardData.main_title_2,
                                size: 'sm',
                                color: '#666666',
                                wrap: true,
                                margin: 'md'
                            },
                            {
                                type: 'box',
                                layout: 'horizontal',
                                contents: [
                                    cardData.member_image_url ? {
                                        type: 'image',
                                        url: cardData.member_image_url,
                                        size: 'sm',
                                        flex: 0
                                    } : undefined,
                                    {
                                        type: 'text',
                                        text: cardData.display_name,
                                        weight: 'bold',
                                        size: 'md',
                                        gravity: 'center',
                                        margin: 'md'
                                    }
                                ].filter(Boolean),
                                margin: 'lg'
                            }
                        ]
                    },
                    footer: cardData.button_1_text ? {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'button',
                                style: 'primary',
                                action: {
                                    type: 'uri',
                                    label: cardData.button_1_text,
                                    uri: cardData.button_1_url || 'https://example.com'
                                }
                            }
                        ]
                    } : undefined
                };
            }
            
            saveToCache() {
                const formData = this.getFormData();
                localStorage.setItem('fastEditor_cardData', JSON.stringify(formData));
            }
            
            updateStats() {
                document.getElementById('cacheHits').textContent = this.cacheHits;
            }
        }
        
        // ğŸ”§ å…¨åŸŸå‡½æ•¸
        function shareToLine() {
            const formData = window.fastEditor.getFormData();
            
            // ç”ŸæˆåŒ…å«å¡ç‰‡è³‡æ–™çš„LIFF URL
            const shareData = btoa(JSON.stringify(formData));
            const liffUrl = `https://barv3.vercel.app/mcard-mtest.html?shareData=${shareData}`;
            
            // é–‹å•Ÿæ–°è¦–çª—é€²è¡Œåˆ†äº«
            window.open(liffUrl, '_blank');
            
            alert('ğŸš€ å·²é–‹å•ŸLINEåˆ†äº«è¦–çª—ï¼');
        }
        
        function saveCard() {
            const formData = window.fastEditor.getFormData();
            
            // å„²å­˜åˆ°localStorage
            localStorage.setItem('savedCard_' + Date.now(), JSON.stringify(formData));
            
            alert('ğŸ’¾ å¡ç‰‡å·²å„²å­˜ï¼');
        }
        
        // ğŸŒ å¤šå¹³å°åˆ†äº«å‡½æ•¸
        function shareToEmail() {
            const formData = window.fastEditor.getFormData();
            const shareData = btoa(JSON.stringify(formData));
            const emailUrl = `/share-email.html?shareData=${shareData}`;
            
            window.open(emailUrl, '_blank');
            console.log('ğŸ“§ é–‹å•ŸEMAILåˆ†äº«é é¢');
        }
        
        function shareToFacebook() {
            const formData = window.fastEditor.getFormData();
            const shareData = btoa(JSON.stringify(formData));
            const fbUrl = `/share-facebook.html?shareData=${shareData}`;
            
            window.open(fbUrl, '_blank');
            console.log('ğŸ“˜ é–‹å•ŸFacebookåˆ†äº«é é¢');
        }
        
        function shareToOthers() {
            const formData = window.fastEditor.getFormData();
            const shareData = btoa(JSON.stringify(formData));
            const otherUrl = `/share-universal.html?shareData=${shareData}`;
            
            window.open(otherUrl, '_blank');
            console.log('ğŸŒ é–‹å•Ÿé€šç”¨åˆ†äº«é é¢');
        }
        
        function copyCardData() {
            const formData = window.fastEditor.getFormData();
            const cardJson = JSON.stringify(formData, null, 2);
            
            navigator.clipboard.writeText(cardJson).then(() => {
                alert('ğŸ“‹ å¡ç‰‡è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                // å‚™ç”¨æ–¹æ¡ˆï¼šå‰µå»ºè‡¨æ™‚æ–‡æœ¬åŸŸ
                const textarea = document.createElement('textarea');
                textarea.value = cardJson;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('ğŸ“‹ å¡ç‰‡è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }
        
        function authorizeWithLine() {
            // è·³è½‰åˆ°LINEæˆæ¬Šæ©‹æ¥é é¢
            const currentUrl = encodeURIComponent(window.location.href);
            const authUrl = `/line-auth-bridge.html?returnUrl=${currentUrl}`;
            window.location.href = authUrl;
        }
        
        function importFromLine() {
            // å¦‚æœå·²ç¶“æœ‰LINEå€‹è³‡ï¼Œç›´æ¥æ›´æ–°
            if (window.fastEditor.lineProfile) {
                const formData = window.fastEditor.getFormData();
                formData.display_name = window.fastEditor.lineProfile.displayName;
                formData.member_image_url = window.fastEditor.lineProfile.pictureUrl;
                
                // æ›´æ–°è¡¨å–®
                document.getElementById('display_name').value = formData.display_name;
                document.getElementById('member_image_url').value = formData.member_image_url;
                
                // æ›´æ–°é è¦½
                window.fastEditor.updatePreview();
                window.fastEditor.saveToCache();
                
                alert('âœ… å·²ä½¿ç”¨æ‚¨çš„LINEå€‹è³‡æ›´æ–°å¡ç‰‡ï¼');
            } else {
                // æ²’æœ‰LINEå€‹è³‡ï¼Œé€²è¡Œæˆæ¬Š
                authorizeWithLine();
            }
        }
        
        function exportCard() {
            const formData = window.fastEditor.getFormData();
            
            // å‰µå»ºä¸‹è¼‰é€£çµ
            const dataStr = JSON.stringify(formData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `card_${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        function refreshPreview() {
            window.fastEditor.updatePreview();
        }
        
        function fullScreenPreview() {
            const preview = document.getElementById('preview-container');
            if (preview.requestFullscreen) {
                preview.requestFullscreen();
            }
        }
        
        function clearCache() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¿«å–è³‡æ–™å—ï¼Ÿé€™å°‡ç§»é™¤LINEå€‹è³‡å’Œå¡ç‰‡è³‡æ–™ã€‚')) {
                // æ¸…é™¤LINEå€‹è³‡
                localStorage.removeItem('lineUserProfile');
                localStorage.removeItem('lineAuthCompleted');
                
                // æ¸…é™¤å¡ç‰‡å¿«å–
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('fastEditor_') || key.startsWith('savedCard_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                alert('âœ… å¿«å–å·²æ¸…é™¤ï¼é é¢å°‡é‡æ–°è¼‰å…¥ã€‚');
                window.location.reload();
            }
        }
        
        // ğŸš€ åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.fastEditor = new FastEditor();
        });
    </script>
</body>
</html> 