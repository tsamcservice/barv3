<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»æ•¸ç³»çµ±èª¿è©¦å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { background: #f9f9f9; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ é»æ•¸ç³»çµ±èª¿è©¦å·¥å…·</h1>
    
    <div class="section">
        <h3>ğŸ“Š 1. æª¢æŸ¥ç”¨æˆ¶ç•¶å‰é»æ•¸</h3>
        <input type="text" id="userIdInput" placeholder="è¼¸å…¥LINEç”¨æˆ¶ID" />
        <button onclick="checkUserPoints()">æŸ¥è©¢é»æ•¸</button>
        <div id="userPointsResult" class="result"></div>
    </div>
    
    <div class="section">
        <h3>âš™ï¸ 2. æª¢æŸ¥åˆå§‹é»æ•¸è¨­å®š</h3>
        <button onclick="checkInitialPointsConfig()">æŸ¥è©¢åˆå§‹é»æ•¸è¨­å®š</button>
        <div id="configResult" class="result"></div>
    </div>
    
    <div class="section">
        <h3>ğŸ¯ 3. æ¨¡æ“¬åˆ†äº«é»æ•¸è¨ˆç®—</h3>
        <input type="text" id="simulateUserId" placeholder="ç”¨æˆ¶ID" />
        <input type="number" id="simulateCurrentPoints" placeholder="ç•¶å‰é»æ•¸" value="200" />
        <button onclick="simulateShareCalculation()">æ¨¡æ“¬è¨ˆç®—</button>
        <div id="simulateResult" class="result"></div>
    </div>
    
    <div class="section">
        <h3>ğŸ“ˆ 4. æª¢æŸ¥é»æ•¸äº¤æ˜“è¨˜éŒ„</h3>
        <input type="text" id="transactionUserId" placeholder="ç”¨æˆ¶ID" />
        <button onclick="checkTransactionHistory()">æŸ¥è©¢äº¤æ˜“è¨˜éŒ„</button>
        <div id="transactionResult" class="result"></div>
    </div>

    <script>
        // æŸ¥è©¢ç”¨æˆ¶é»æ•¸
        async function checkUserPoints() {
            const userId = document.getElementById('userIdInput').value;
            if (!userId) {
                alert('è«‹è¼¸å…¥ç”¨æˆ¶ID');
                return;
            }
            
            const resultDiv = document.getElementById('userPointsResult');
            resultDiv.innerHTML = 'æŸ¥è©¢ä¸­...';
            
            try {
                const response = await fetch(`/api/cards?pageId=M01001&userId=${userId}`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    const userData = result.data[0];
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>âœ… æ‰¾åˆ°ç”¨æˆ¶è³‡æ–™</h4>
                        <p><strong>ç”¨æˆ¶ID:</strong> ${userData.line_user_id}</p>
                        <p><strong>é¡¯ç¤ºåç¨±:</strong> ${userData.display_name}</p>
                        <p><strong>ç•¶å‰é»æ•¸:</strong> ${userData.user_points}</p>
                        <p><strong>å¡ç‰‡ID:</strong> ${userData.id}</p>
                        <p><strong>æœ€å¾Œæ›´æ–°:</strong> ${userData.updated_at}</p>
                        <pre>${JSON.stringify(userData, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>âŒ æœªæ‰¾åˆ°ç”¨æˆ¶è³‡æ–™</h4>
                        <p>é€™æ˜¯æ–°ç”¨æˆ¶ï¼Œå°‡ä½¿ç”¨åˆå§‹é»æ•¸è¨­å®š</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>âŒ æŸ¥è©¢å¤±æ•—</h4><p>${error.message}</p>`;
            }
        }
        
        // æŸ¥è©¢åˆå§‹é»æ•¸è¨­å®š
        async function checkInitialPointsConfig() {
            const resultDiv = document.getElementById('configResult');
            resultDiv.innerHTML = 'æŸ¥è©¢ä¸­...';
            
            try {
                const response = await fetch('/api/initial-points-settings?pageId=M01001');
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>âœ… åˆå§‹é»æ•¸è¨­å®š</h4>
                        <p><strong>é é¢ID:</strong> ${result.data.pageId}</p>
                        <p><strong>åˆå§‹é»æ•¸:</strong> ${result.data.initialPoints}</p>
                        <p><strong>è³‡æ–™ä¾†æº:</strong> ${result.data.source}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>âŒ è®€å–å¤±æ•—</h4>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>âŒ æŸ¥è©¢å¤±æ•—</h4><p>${error.message}</p>`;
            }
        }
        
        // æ¨¡æ“¬åˆ†äº«é»æ•¸è¨ˆç®—
        async function simulateShareCalculation() {
            const userId = document.getElementById('simulateUserId').value;
            const currentPoints = parseInt(document.getElementById('simulateCurrentPoints').value);
            
            if (!userId || !currentPoints) {
                alert('è«‹å¡«å…¥å®Œæ•´è³‡è¨Š');
                return;
            }
            
            const resultDiv = document.getElementById('simulateResult');
            resultDiv.innerHTML = 'è¨ˆç®—ä¸­...';
            
            try {
                // æ¨¡æ“¬MTESTçš„checkUserPointsAsyncé‚è¼¯
                const userResponse = await fetch(`/api/cards?pageId=M01001&userId=${userId}`);
                const userResult = await userResponse.json();
                
                let pointsData;
                if (userResult.success && userResult.data && userResult.data.length > 0) {
                    const actualPoints = userResult.data[0].user_points;
                    pointsData = {
                        mainCardId: userResult.data[0].id,
                        currentPoints: actualPoints,
                        cardExists: true,
                        cardData: userResult.data[0]
                    };
                } else {
                    const configResponse = await fetch('/api/initial-points-settings?pageId=M01001');
                    const configResult = await configResponse.json();
                    const defaultPoints = configResult.success ? configResult.data.initialPoints : 168;
                    
                    pointsData = {
                        mainCardId: null,
                        currentPoints: defaultPoints,
                        cardExists: false,
                        cardData: null
                    };
                }
                
                // è¨ˆç®—åˆ†äº«æ‰€éœ€é»æ•¸ (å‡è¨­1å¼µå¡)
                const requiredPoints = 10;
                const canShare = pointsData.currentPoints >= requiredPoints;
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <h4>ğŸ¯ åˆ†äº«é»æ•¸è¨ˆç®—çµæœ</h4>
                    <p><strong>ç”¨æˆ¶å­˜åœ¨:</strong> ${pointsData.cardExists ? 'æ˜¯' : 'å¦'}</p>
                    <p><strong>ä¸»å¡ID:</strong> ${pointsData.mainCardId || 'ç„¡(æ–°ç”¨æˆ¶)'}</p>
                    <p><strong>ç•¶å‰é»æ•¸:</strong> ${pointsData.currentPoints}</p>
                    <p><strong>éœ€è¦é»æ•¸:</strong> ${requiredPoints}</p>
                    <p><strong>å¯ä»¥åˆ†äº«:</strong> ${canShare ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                    
                    <h5>ğŸ“Š è©³ç´°è³‡æ–™:</h5>
                    <pre>${JSON.stringify(pointsData, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>âŒ è¨ˆç®—å¤±æ•—</h4><p>${error.message}</p>`;
            }
        }
        
        // æŸ¥è©¢äº¤æ˜“è¨˜éŒ„ (å¦‚æœæœ‰çš„è©±)
        async function checkTransactionHistory() {
            const userId = document.getElementById('transactionUserId').value;
            if (!userId) {
                alert('è«‹è¼¸å…¥ç”¨æˆ¶ID');
                return;
            }
            
            const resultDiv = document.getElementById('transactionResult');
            resultDiv.innerHTML = 'æŸ¥è©¢ä¸­...';
            
            try {
                // é€™è£¡å¯ä»¥æ·»åŠ æŸ¥è©¢points_transactionsçš„é‚è¼¯
                // æš«æ™‚é¡¯ç¤ºæç¤º
                resultDiv.className = 'result';
                resultDiv.innerHTML = `
                    <h4>ğŸ“ˆ äº¤æ˜“è¨˜éŒ„æŸ¥è©¢</h4>
                    <p>æ­¤åŠŸèƒ½éœ€è¦é¡å¤–çš„APIç«¯é»ä¾†æŸ¥è©¢points_transactionsè¡¨</p>
                    <p>ç”¨æˆ¶ID: ${userId}</p>
                    <p>å»ºè­°æª¢æŸ¥Supabaseä¸­çš„points_transactionsè¡¨</p>
                `;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>âŒ æŸ¥è©¢å¤±æ•—</h4><p>${error.message}</p>`;
            }
        }
    </script>
</body>
</html> 