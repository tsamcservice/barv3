<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手機版會員卡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- 🔧 移除 flex2html.min.js 避免資料污染 -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .login-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .login-status.success {
            background: #4caf50;
            color: white;
        }
        .login-status.error {
            background: #f44336;
            color: white;
        }
        .login-status.loading {
            background: #2196f3;
            color: white;
        }
        
        .tab-nav {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            margin-top: 8px;
            display: none;
        }
        
        .image-preview.show {
            display: block;
        }
        
        .preview-container {
            background: #849ebf;
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            overflow-x: auto;
        }
        
        .flex-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            width: 320px;
            margin: 0 auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .flex-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .flex-card-body {
            padding: 16px;
        }
        
        .flex-card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .flex-card-subtitle {
            font-size: 14px;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        .flex-card-member {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .flex-card-member img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .flex-card-member-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .flex-card-footer {
            padding: 0 16px 16px;
        }
        
        .flex-card-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            cursor: pointer;
            text-decoration: none;
            display: block;
            text-align: center;
        }
        
        .flex-card-button.primary {
            color: white;
        }
        
        .flex-card-button.secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .save-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="login-status" class="login-status" style="display: none;"></div>
    
    <div class="container">
        <h1 style="text-align: center; color: white; margin: 20px 0; font-size: 24px;">📱 手機版會員卡</h1>
        
        <!-- 分頁導航 -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('edit')">📝 編輯</button>
            <button class="tab-btn" onclick="switchTab('preview')">👁️ 預覽</button>
        </div>
        
        <!-- 編輯分頁 -->
        <div id="edit-tab" class="tab-content active">
            <form id="cardForm">
                <div class="form-group">
                    <label>卡片標題</label>
                    <input type="text" id="card_alt_title" name="card_alt_title">
                </div>
                
                <div class="form-group">
                    <label>主圖網址</label>
                    <input type="url" id="main_image_url" name="main_image_url">
                </div>
                
                <div class="form-group">
                    <label>主圖連結</label>
                    <input type="url" id="main_image_link" name="main_image_link">
                </div>
                
                <div class="form-group">
                    <label>主標題</label>
                    <input type="text" id="main_title_1" name="main_title_1">
                </div>
                
                <div class="form-group">
                    <label>主標題顏色</label>
                    <input type="color" id="main_title_1_color" name="main_title_1_color" value="#000000">
                </div>
                
                <div class="form-group">
                    <label>副標題</label>
                    <input type="text" id="main_title_2" name="main_title_2">
                </div>
                
                <div class="form-group">
                    <label>副標題顏色</label>
                    <input type="color" id="main_title_2_color" name="main_title_2_color" value="#000000">
                </div>
                
                <div class="form-group">
                    <label>會員圖片</label>
                    <input type="url" id="member_image_url" name="member_image_url">
                    <img id="member_image_preview" class="image-preview">
                </div>
                
                <div class="form-group">
                    <label>會員圖片連結</label>
                    <input type="url" id="member_image_link" name="member_image_link">
                </div>
                
                <div class="form-group">
                    <label>會員名字</label>
                    <input type="text" id="display_name" name="display_name">
                </div>
                
                <div class="form-group">
                    <label>會員名字顏色</label>
                    <input type="color" id="name_color1" name="name_color1" value="#A4924C">
                </div>
                
                <div class="form-group">
                    <label>按鈕文字</label>
                    <input type="text" id="button_1_text" name="button_1_text">
                </div>
                
                <div class="form-group">
                    <label>按鈕連結</label>
                    <input type="url" id="button_1_url" name="button_1_url">
                </div>
                
                <div class="form-group">
                    <label>按鈕顏色</label>
                    <input type="color" id="button_1_color" name="button_1_color" value="#A4924A">
                </div>
                
                <div class="form-group">
                    <label>分享按鈕文字</label>
                    <input type="text" id="s_button_text" name="s_button_text">
                </div>
                
                <div class="form-group">
                    <label>分享按鈕連結</label>
                    <input type="url" id="s_button_url" name="s_button_url" readonly>
                </div>
                
                <div class="form-group">
                    <label>分享按鈕顏色</label>
                    <input type="color" id="s_button_color" name="s_button_color" value="#A4924B">
                </div>
                
                <button type="submit" class="save-btn">💾 儲存卡片</button>
            </form>
        </div>
        
        <!-- 預覽分頁 -->
        <div id="preview-tab" class="tab-content">
            <div class="preview-container">
                <div id="main-card-preview" class="flex-card">
                    <!-- 預覽內容將在這裡顯示 -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 🔧 手機版專用：完全獨立的邏輯，不依賴任何外部JS
        let currentUser = null;
        
        console.log('📱 手機版會員卡開始載入 - 完全獨立版本');
        
        // 🔧 關鍵：清空所有可能的全域變數污染
        window.defaultCard = undefined;
        window.loadedCardData = undefined;
        window.selectedPromoCardIds = undefined;
        window.liffProfile = undefined;
        
        // 分頁切換
        function switchTab(tab) {
            console.log('🔄 切換分頁:', tab);
            
            // 更新按鈕狀態
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            // 更新內容顯示
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            // 如果切換到預覽，更新預覽
            if (tab === 'preview') {
                updatePreview();
            }
        }
        
        // 顯示登入狀態
        function showStatus(message, type) {
            console.log('📱 狀態更新:', message, type);
            const status = document.getElementById('login-status');
            status.textContent = message;
            status.className = `login-status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }
        
        // LIFF初始化和登入
        async function initLiffAndLogin() {
            try {
                console.log('🚀 開始LIFF初始化（手機版獨立）');
                showStatus('🔄 正在初始化...', 'loading');
                
                // 檢查LIFF環境
                if (typeof liff === 'undefined') {
                    console.warn('⚠️ 不在LINE環境中');
                    showStatus('⚠️ 請在LINE中開啟', 'error');
                    fillDefaults();
                    return;
                }
                
                console.log('✅ LIFF SDK已載入');
                
                // 初始化LIFF
                await liff.init({ liffId: '2007327814-DGly5XNk' });
                console.log('✅ LIFF初始化成功');
                
                // 檢查登入狀態
                if (!liff.isLoggedIn()) {
                    console.log('🔐 未登入，開始登入');
                    showStatus('🔐 請登入LINE', 'loading');
                    liff.login();
                    return;
                }
                
                console.log('✅ 已登入LINE');
                
                // 獲取用戶資料
                showStatus('📋 載入用戶資料...', 'loading');
                const profile = await liff.getProfile();
                currentUser = profile;
                console.log('✅ 用戶資料獲取成功:', profile);
                
                fillUserData(profile);
                showStatus(`✅ 歡迎，${profile.displayName}！`, 'success');
                
            } catch (error) {
                console.error('❌ LIFF錯誤:', error);
                showStatus('❌ 初始化失敗，使用預設資料', 'error');
                fillDefaults();
            }
        }
        
        // 填入用戶資料
        function fillUserData(profile) {
            console.log('📝 填入手機版用戶資料:', profile);
            
            // 🔧 關鍵：使用完全純淨的用戶資料
            const userData = {
                card_alt_title: profile.displayName || '我的會員卡',
                main_image_url: 'https://barv3.vercel.app/uploads/vip/TS-B1.png',
                main_image_link: 'https://secure.smore.com/n/td1qc',
                main_title_1: '我在呈璽',
                main_title_1_color: '#000000',
                main_title_2: '我在呈璽，欣賞美好幸福！',
                main_title_2_color: '#000000',
                member_image_url: profile.pictureUrl || 'https://barv3.vercel.app/uploads/vip/TS-LOGO.png',
                member_image_link: 'https://secure.smore.com/n/td1qc',
                display_name: profile.displayName || '呈璽用戶',
                name_color1: '#A4924C',
                button_1_text: '加呈璽好友',
                button_1_url: 'https://lin.ee/JLLIBlP',
                button_1_color: '#A4924A',
                s_button_text: '分享給好友',
                s_button_url: `https://liff.line.me/2007327814-DGly5XNk?pageId=M01001&userId=${profile.userId}`,
                s_button_color: '#A4924B'
            };
            
            // 清空並重新填入所有欄位
            Object.keys(userData).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = '';  // 先清空
                    element.value = userData[key];  // 再填入
                    console.log(`✅ 設定 [${key}]:`, userData[key]);
                }
            });
            
            // 顯示用戶頭貼
            if (profile.pictureUrl) {
                const preview = document.getElementById('member_image_preview');
                preview.src = profile.pictureUrl;
                preview.classList.add('show');
            }
            
            updatePreview();
        }
        
        // 填入預設資料
        function fillDefaults() {
            console.log('📝 填入手機版預設資料');
            
            const defaults = {
                card_alt_title: '我的會員卡',
                main_image_url: 'https://barv3.vercel.app/uploads/vip/TS-B1.png',
                main_image_link: 'https://secure.smore.com/n/td1qc',
                main_title_1: '我在呈璽',
                main_title_1_color: '#000000',
                main_title_2: '我在呈璽，欣賞美好幸福！',
                main_title_2_color: '#000000',
                member_image_url: 'https://barv3.vercel.app/uploads/vip/TS-LOGO.png',
                member_image_link: 'https://secure.smore.com/n/td1qc',
                display_name: '呈璽用戶',
                name_color1: '#A4924C',
                button_1_text: '加呈璽好友',
                button_1_url: 'https://lin.ee/JLLIBlP',
                button_1_color: '#A4924A',
                s_button_text: '分享給好友',
                s_button_url: 'https://liff.line.me/2007327814-DGly5XNk?pageId=M01001',
                s_button_color: '#A4924B'
            };
            
            // 清空並重新填入所有欄位
            Object.keys(defaults).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = '';  // 先清空
                    element.value = defaults[key];  // 再填入
                    console.log(`✅ 設定預設 [${key}]:`, defaults[key]);
                }
            });
            
            updatePreview();
        }
        
        // 更新預覽（使用純HTML，不依賴FlexToHtml）
        function updatePreview() {
            try {
                console.log('🔄 更新手機版預覽');
                
                const formData = new FormData(document.getElementById('cardForm'));
                const data = Object.fromEntries(formData);
                
                const preview = document.getElementById('main-card-preview');
                preview.innerHTML = `
                    <img src="${data.main_image_url || 'https://barv3.vercel.app/uploads/vip/TS-B1.png'}" alt="主圖" onclick="window.open('${data.main_image_link || '#'}')">
                    <div class="flex-card-body">
                        <div class="flex-card-title" style="color: ${data.main_title_1_color || '#000000'}">
                            ${data.main_title_1 || '我在呈璽'}
                        </div>
                        <div class="flex-card-subtitle" style="color: ${data.main_title_2_color || '#000000'}">
                            ${data.main_title_2 || '我在呈璽，欣賞美好幸福！'}
                        </div>
                        <div class="flex-card-member">
                            <img src="${data.member_image_url || 'https://barv3.vercel.app/uploads/vip/TS-LOGO.png'}" alt="會員圖片" onclick="window.open('${data.member_image_link || '#'}')">
                            <div class="flex-card-member-name" style="color: ${data.name_color1 || '#A4924C'}">
                                ${data.display_name || '呈璽用戶'}
                            </div>
                        </div>
                    </div>
                    <div class="flex-card-footer">
                        <a href="${data.button_1_url || '#'}" class="flex-card-button primary" style="background-color: ${data.button_1_color || '#A4924A'}">
                            ${data.button_1_text || '加呈璽好友'}
                        </a>
                        <a href="${data.s_button_url || '#'}" class="flex-card-button secondary" style="background-color: ${data.s_button_color || '#A4924B'}; color: white;">
                            ${data.s_button_text || '分享給好友'}
                        </a>
                    </div>
                `;
                
                console.log('✅ 預覽更新完成');
            } catch (error) {
                console.error('❌ 預覽更新失敗:', error);
            }
        }
        
        // 儲存卡片
        async function saveCard(event) {
            event.preventDefault();
            
            if (!currentUser) {
                showStatus('❌ 請先登入LINE', 'error');
                return;
            }
            
            try {
                showStatus('💾 正在儲存...', 'loading');
                
                const formData = new FormData(document.getElementById('cardForm'));
                const cardData = Object.fromEntries(formData);
                cardData.userId = currentUser.userId;
                cardData.pageId = 'M01001';
                
                console.log('💾 準備儲存資料:', cardData);
                
                const response = await fetch('/api/cards/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(cardData)
                });
                
                const result = await response.json();
                console.log('💾 儲存結果:', result);
                
                if (result.success) {
                    showStatus('✅ 儲存成功！', 'success');
                } else {
                    showStatus('❌ 儲存失敗', 'error');
                }
            } catch (error) {
                console.error('❌ 儲存錯誤:', error);
                showStatus('❌ 儲存失敗', 'error');
            }
        }
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📱 手機版會員卡DOM載入完成');
            
            // 🔧 關鍵：立即清空任何可能的資料污染
            console.log('🧹 清理可能的資料污染...');
            
            // 清空所有表單欄位
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.type !== 'color') {
                    input.value = '';
                }
            });
            
            console.log('✅ 表單欄位已清空');
            
            // 綁定表單事件
            document.getElementById('cardForm').addEventListener('submit', saveCard);
            
            // 綁定輸入框變更事件
            inputs.forEach(input => {
                input.addEventListener('input', updatePreview);
            });
            
            // 延遲開始初始化，確保頁面完全載入
            setTimeout(() => {
                console.log('🚀 開始手機版初始化流程');
                initLiffAndLogin();
            }, 100);
        });
    </script>
</body>
</html> 