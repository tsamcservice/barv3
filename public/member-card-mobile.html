<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æ©Ÿç‰ˆæœƒå“¡å¡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- ğŸ”§ ç§»é™¤ flex2html.min.js é¿å…è³‡æ–™æ±¡æŸ“ -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .login-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .login-status.success {
            background: #4caf50;
            color: white;
        }
        .login-status.error {
            background: #f44336;
            color: white;
        }
        .login-status.loading {
            background: #2196f3;
            color: white;
        }
        
        .tab-nav {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            margin-top: 8px;
            display: none;
        }
        
        .image-preview.show {
            display: block;
        }
        
        .preview-container {
            background: #849ebf;
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            overflow-x: auto;
        }
        
        .flex-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            width: 320px;
            margin: 0 auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .flex-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .flex-card-body {
            padding: 16px;
        }
        
        .flex-card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .flex-card-subtitle {
            font-size: 14px;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        .flex-card-member {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .flex-card-member img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .flex-card-member-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .flex-card-footer {
            padding: 0 16px 16px;
        }
        
        .flex-card-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            cursor: pointer;
            text-decoration: none;
            display: block;
            text-align: center;
        }
        
        .flex-card-button.primary {
            color: white;
        }
        
        .flex-card-button.secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .save-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="login-status" class="login-status" style="display: none;"></div>
    
    <div class="container">
        <h1 style="text-align: center; color: white; margin: 20px 0; font-size: 24px;">ğŸ“± æ‰‹æ©Ÿç‰ˆæœƒå“¡å¡</h1>
        
        <!-- åˆ†é å°èˆª -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('edit')">ğŸ“ ç·¨è¼¯</button>
            <button class="tab-btn" onclick="switchTab('preview')">ğŸ‘ï¸ é è¦½</button>
        </div>
        
        <!-- ç·¨è¼¯åˆ†é  -->
        <div id="edit-tab" class="tab-content active">
            <form id="cardForm">
                <div class="form-group">
                    <label>å¡ç‰‡æ¨™é¡Œ</label>
                    <input type="text" id="card_alt_title" name="card_alt_title">
                </div>
                
                <div class="form-group">
                    <label>ä¸»åœ–ç¶²å€</label>
                    <input type="url" id="main_image_url" name="main_image_url">
                </div>
                
                <div class="form-group">
                    <label>ä¸»åœ–é€£çµ</label>
                    <input type="url" id="main_image_link" name="main_image_link">
                </div>
                
                <div class="form-group">
                    <label>ä¸»æ¨™é¡Œ</label>
                    <input type="text" id="main_title_1" name="main_title_1">
                </div>
                
                <div class="form-group">
                    <label>ä¸»æ¨™é¡Œé¡è‰²</label>
                    <input type="color" id="main_title_1_color" name="main_title_1_color" value="#000000">
                </div>
                
                <div class="form-group">
                    <label>å‰¯æ¨™é¡Œ</label>
                    <input type="text" id="main_title_2" name="main_title_2">
                </div>
                
                <div class="form-group">
                    <label>å‰¯æ¨™é¡Œé¡è‰²</label>
                    <input type="color" id="main_title_2_color" name="main_title_2_color" value="#000000">
                </div>
                
                <div class="form-group">
                    <label>æœƒå“¡åœ–ç‰‡</label>
                    <input type="url" id="member_image_url" name="member_image_url">
                    <img id="member_image_preview" class="image-preview">
                </div>
                
                <div class="form-group">
                    <label>æœƒå“¡åœ–ç‰‡é€£çµ</label>
                    <input type="url" id="member_image_link" name="member_image_link">
                </div>
                
                <div class="form-group">
                    <label>æœƒå“¡åå­—</label>
                    <input type="text" id="display_name" name="display_name">
                </div>
                
                <div class="form-group">
                    <label>æœƒå“¡åå­—é¡è‰²</label>
                    <input type="color" id="name_color1" name="name_color1" value="#A4924C">
                </div>
                
                <div class="form-group">
                    <label>æŒ‰éˆ•æ–‡å­—</label>
                    <input type="text" id="button_1_text" name="button_1_text">
                </div>
                
                <div class="form-group">
                    <label>æŒ‰éˆ•é€£çµ</label>
                    <input type="url" id="button_1_url" name="button_1_url">
                </div>
                
                <div class="form-group">
                    <label>æŒ‰éˆ•é¡è‰²</label>
                    <input type="color" id="button_1_color" name="button_1_color" value="#A4924A">
                </div>
                
                <div class="form-group">
                    <label>åˆ†äº«æŒ‰éˆ•æ–‡å­—</label>
                    <input type="text" id="s_button_text" name="s_button_text">
                </div>
                
                <div class="form-group">
                    <label>åˆ†äº«æŒ‰éˆ•é€£çµ</label>
                    <input type="url" id="s_button_url" name="s_button_url" readonly>
                </div>
                
                <div class="form-group">
                    <label>åˆ†äº«æŒ‰éˆ•é¡è‰²</label>
                    <input type="color" id="s_button_color" name="s_button_color" value="#A4924B">
                </div>
                
                <button type="submit" class="save-btn">ğŸ’¾ å„²å­˜å¡ç‰‡</button>
            </form>
        </div>
        
        <!-- é è¦½åˆ†é  -->
        <div id="preview-tab" class="tab-content">
            <div class="preview-container">
                <div id="main-card-preview" class="flex-card">
                    <!-- é è¦½å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ğŸ”§ æ‰‹æ©Ÿç‰ˆå°ˆç”¨ï¼šå®Œå…¨ç¨ç«‹çš„é‚è¼¯ï¼Œä¸ä¾è³´ä»»ä½•å¤–éƒ¨JS
        let currentUser = null;
        
        console.log('ğŸ“± æ‰‹æ©Ÿç‰ˆæœƒå“¡å¡é–‹å§‹è¼‰å…¥ - å®Œå…¨ç¨ç«‹ç‰ˆæœ¬');
        
        // ğŸ”§ é—œéµï¼šæ¸…ç©ºæ‰€æœ‰å¯èƒ½çš„å…¨åŸŸè®Šæ•¸æ±¡æŸ“
        window.defaultCard = undefined;
        window.loadedCardData = undefined;
        window.selectedPromoCardIds = undefined;
        window.liffProfile = undefined;
        
        // åˆ†é åˆ‡æ›
        function switchTab(tab) {
            console.log('ğŸ”„ åˆ‡æ›åˆ†é :', tab);
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            // æ›´æ–°å…§å®¹é¡¯ç¤º
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            // å¦‚æœåˆ‡æ›åˆ°é è¦½ï¼Œæ›´æ–°é è¦½
            if (tab === 'preview') {
                updatePreview();
            }
        }
        
        // é¡¯ç¤ºç™»å…¥ç‹€æ…‹
        function showStatus(message, type) {
            console.log('ğŸ“± ç‹€æ…‹æ›´æ–°:', message, type);
            const status = document.getElementById('login-status');
            status.textContent = message;
            status.className = `login-status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }
        
        // LIFFåˆå§‹åŒ–å’Œç™»å…¥
        async function initLiffAndLogin() {
            try {
                console.log('ğŸš€ é–‹å§‹LIFFåˆå§‹åŒ–ï¼ˆæ‰‹æ©Ÿç‰ˆç¨ç«‹ï¼‰');
                showStatus('ğŸ”„ æ­£åœ¨åˆå§‹åŒ–...', 'loading');
                
                // æª¢æŸ¥LIFFç’°å¢ƒ
                if (typeof liff === 'undefined') {
                    console.warn('âš ï¸ ä¸åœ¨LINEç’°å¢ƒä¸­');
                    showStatus('âš ï¸ è«‹åœ¨LINEä¸­é–‹å•Ÿ', 'error');
                    fillDefaults();
                    return;
                }
                
                console.log('âœ… LIFF SDKå·²è¼‰å…¥');
                
                // åˆå§‹åŒ–LIFF
                await liff.init({ liffId: '2007327814-DGly5XNk' });
                console.log('âœ… LIFFåˆå§‹åŒ–æˆåŠŸ');
                
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (!liff.isLoggedIn()) {
                    console.log('ğŸ” æœªç™»å…¥ï¼Œé–‹å§‹ç™»å…¥');
                    showStatus('ğŸ” è«‹ç™»å…¥LINE', 'loading');
                    liff.login();
                    return;
                }
                
                console.log('âœ… å·²ç™»å…¥LINE');
                
                // ç²å–ç”¨æˆ¶è³‡æ–™
                showStatus('ğŸ“‹ è¼‰å…¥ç”¨æˆ¶è³‡æ–™...', 'loading');
                const profile = await liff.getProfile();
                currentUser = profile;
                console.log('âœ… ç”¨æˆ¶è³‡æ–™ç²å–æˆåŠŸ:', profile);
                
                fillUserData(profile);
                showStatus(`âœ… æ­¡è¿ï¼Œ${profile.displayName}ï¼`, 'success');
                
            } catch (error) {
                console.error('âŒ LIFFéŒ¯èª¤:', error);
                showStatus('âŒ åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™', 'error');
                fillDefaults();
            }
        }
        
        // å¡«å…¥ç”¨æˆ¶è³‡æ–™
        function fillUserData(profile) {
            console.log('ğŸ“ å¡«å…¥æ‰‹æ©Ÿç‰ˆç”¨æˆ¶è³‡æ–™:', profile);
            
            // ğŸ”§ é—œéµï¼šä½¿ç”¨å®Œå…¨ç´”æ·¨çš„ç”¨æˆ¶è³‡æ–™
            const userData = {
                card_alt_title: profile.displayName || 'æˆ‘çš„æœƒå“¡å¡',
                main_image_url: 'https://barv3.vercel.app/uploads/vip/TS-B1.png',
                main_image_link: 'https://secure.smore.com/n/td1qc',
                main_title_1: 'æˆ‘åœ¨å‘ˆç’½',
                main_title_1_color: '#000000',
                main_title_2: 'æˆ‘åœ¨å‘ˆç’½ï¼Œæ¬£è³ç¾å¥½å¹¸ç¦ï¼',
                main_title_2_color: '#000000',
                member_image_url: profile.pictureUrl || 'https://barv3.vercel.app/uploads/vip/TS-LOGO.png',
                member_image_link: 'https://secure.smore.com/n/td1qc',
                display_name: profile.displayName || 'å‘ˆç’½ç”¨æˆ¶',
                name_color1: '#A4924C',
                button_1_text: 'åŠ å‘ˆç’½å¥½å‹',
                button_1_url: 'https://lin.ee/JLLIBlP',
                button_1_color: '#A4924A',
                s_button_text: 'åˆ†äº«çµ¦å¥½å‹',
                s_button_url: `https://liff.line.me/2007327814-DGly5XNk?pageId=M01001&userId=${profile.userId}`,
                s_button_color: '#A4924B'
            };
            
            // æ¸…ç©ºä¸¦é‡æ–°å¡«å…¥æ‰€æœ‰æ¬„ä½
            Object.keys(userData).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = '';  // å…ˆæ¸…ç©º
                    element.value = userData[key];  // å†å¡«å…¥
                    console.log(`âœ… è¨­å®š [${key}]:`, userData[key]);
                }
            });
            
            // é¡¯ç¤ºç”¨æˆ¶é ­è²¼
            if (profile.pictureUrl) {
                const preview = document.getElementById('member_image_preview');
                preview.src = profile.pictureUrl;
                preview.classList.add('show');
            }
            
            updatePreview();
        }
        
        // å¡«å…¥é è¨­è³‡æ–™
        function fillDefaults() {
            console.log('ğŸ“ å¡«å…¥æ‰‹æ©Ÿç‰ˆé è¨­è³‡æ–™');
            
            const defaults = {
                card_alt_title: 'æˆ‘çš„æœƒå“¡å¡',
                main_image_url: 'https://barv3.vercel.app/uploads/vip/TS-B1.png',
                main_image_link: 'https://secure.smore.com/n/td1qc',
                main_title_1: 'æˆ‘åœ¨å‘ˆç’½',
                main_title_1_color: '#000000',
                main_title_2: 'æˆ‘åœ¨å‘ˆç’½ï¼Œæ¬£è³ç¾å¥½å¹¸ç¦ï¼',
                main_title_2_color: '#000000',
                member_image_url: 'https://barv3.vercel.app/uploads/vip/TS-LOGO.png',
                member_image_link: 'https://secure.smore.com/n/td1qc',
                display_name: 'å‘ˆç’½ç”¨æˆ¶',
                name_color1: '#A4924C',
                button_1_text: 'åŠ å‘ˆç’½å¥½å‹',
                button_1_url: 'https://lin.ee/JLLIBlP',
                button_1_color: '#A4924A',
                s_button_text: 'åˆ†äº«çµ¦å¥½å‹',
                s_button_url: 'https://liff.line.me/2007327814-DGly5XNk?pageId=M01001',
                s_button_color: '#A4924B'
            };
            
            // æ¸…ç©ºä¸¦é‡æ–°å¡«å…¥æ‰€æœ‰æ¬„ä½
            Object.keys(defaults).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = '';  // å…ˆæ¸…ç©º
                    element.value = defaults[key];  // å†å¡«å…¥
                    console.log(`âœ… è¨­å®šé è¨­ [${key}]:`, defaults[key]);
                }
            });
            
            updatePreview();
        }
        
        // æ›´æ–°é è¦½ï¼ˆä½¿ç”¨ç´”HTMLï¼Œä¸ä¾è³´FlexToHtmlï¼‰
        function updatePreview() {
            try {
                console.log('ğŸ”„ æ›´æ–°æ‰‹æ©Ÿç‰ˆé è¦½');
                
                const formData = new FormData(document.getElementById('cardForm'));
                const data = Object.fromEntries(formData);
                
                const preview = document.getElementById('main-card-preview');
                preview.innerHTML = `
                    <img src="${data.main_image_url || 'https://barv3.vercel.app/uploads/vip/TS-B1.png'}" alt="ä¸»åœ–" onclick="window.open('${data.main_image_link || '#'}')">
                    <div class="flex-card-body">
                        <div class="flex-card-title" style="color: ${data.main_title_1_color || '#000000'}">
                            ${data.main_title_1 || 'æˆ‘åœ¨å‘ˆç’½'}
                        </div>
                        <div class="flex-card-subtitle" style="color: ${data.main_title_2_color || '#000000'}">
                            ${data.main_title_2 || 'æˆ‘åœ¨å‘ˆç’½ï¼Œæ¬£è³ç¾å¥½å¹¸ç¦ï¼'}
                        </div>
                        <div class="flex-card-member">
                            <img src="${data.member_image_url || 'https://barv3.vercel.app/uploads/vip/TS-LOGO.png'}" alt="æœƒå“¡åœ–ç‰‡" onclick="window.open('${data.member_image_link || '#'}')">
                            <div class="flex-card-member-name" style="color: ${data.name_color1 || '#A4924C'}">
                                ${data.display_name || 'å‘ˆç’½ç”¨æˆ¶'}
                            </div>
                        </div>
                    </div>
                    <div class="flex-card-footer">
                        <a href="${data.button_1_url || '#'}" class="flex-card-button primary" style="background-color: ${data.button_1_color || '#A4924A'}">
                            ${data.button_1_text || 'åŠ å‘ˆç’½å¥½å‹'}
                        </a>
                        <a href="${data.s_button_url || '#'}" class="flex-card-button secondary" style="background-color: ${data.s_button_color || '#A4924B'}; color: white;">
                            ${data.s_button_text || 'åˆ†äº«çµ¦å¥½å‹'}
                        </a>
                    </div>
                `;
                
                console.log('âœ… é è¦½æ›´æ–°å®Œæˆ');
            } catch (error) {
                console.error('âŒ é è¦½æ›´æ–°å¤±æ•—:', error);
            }
        }
        
        // å„²å­˜å¡ç‰‡
        async function saveCard(event) {
            event.preventDefault();
            
            if (!currentUser) {
                showStatus('âŒ è«‹å…ˆç™»å…¥LINE', 'error');
                return;
            }
            
            try {
                showStatus('ğŸ’¾ æ­£åœ¨å„²å­˜...', 'loading');
                
                const formData = new FormData(document.getElementById('cardForm'));
                const cardData = Object.fromEntries(formData);
                cardData.userId = currentUser.userId;
                cardData.pageId = 'M01001';
                
                console.log('ğŸ’¾ æº–å‚™å„²å­˜è³‡æ–™:', cardData);
                
                const response = await fetch('/api/cards/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(cardData)
                });
                
                const result = await response.json();
                console.log('ğŸ’¾ å„²å­˜çµæœ:', result);
                
                if (result.success) {
                    showStatus('âœ… å„²å­˜æˆåŠŸï¼', 'success');
                } else {
                    showStatus('âŒ å„²å­˜å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('âŒ å„²å­˜éŒ¯èª¤:', error);
                showStatus('âŒ å„²å­˜å¤±æ•—', 'error');
            }
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“± æ‰‹æ©Ÿç‰ˆæœƒå“¡å¡DOMè¼‰å…¥å®Œæˆ');
            
            // ğŸ”§ é—œéµï¼šç«‹å³æ¸…ç©ºä»»ä½•å¯èƒ½çš„è³‡æ–™æ±¡æŸ“
            console.log('ğŸ§¹ æ¸…ç†å¯èƒ½çš„è³‡æ–™æ±¡æŸ“...');
            
            // æ¸…ç©ºæ‰€æœ‰è¡¨å–®æ¬„ä½
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.type !== 'color') {
                    input.value = '';
                }
            });
            
            console.log('âœ… è¡¨å–®æ¬„ä½å·²æ¸…ç©º');
            
            // ç¶å®šè¡¨å–®äº‹ä»¶
            document.getElementById('cardForm').addEventListener('submit', saveCard);
            
            // ç¶å®šè¼¸å…¥æ¡†è®Šæ›´äº‹ä»¶
            inputs.forEach(input => {
                input.addEventListener('input', updatePreview);
            });
            
            // å»¶é²é–‹å§‹åˆå§‹åŒ–ï¼Œç¢ºä¿é é¢å®Œå…¨è¼‰å…¥
            setTimeout(() => {
                console.log('ğŸš€ é–‹å§‹æ‰‹æ©Ÿç‰ˆåˆå§‹åŒ–æµç¨‹');
                initLiffAndLogin();
            }, 100);
        });
    </script>
</body>
</html> 