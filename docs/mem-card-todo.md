# 會員卡功能開發待辦（2025-05-31 Final）

## ✅ **已完成功能** 

### 1. 資料庫與 API 基礎建置
- [x] 建立主表 `member_cards`，欄位完整實作
- [x] API 設計完成：
  - GET `/api/cards?pageId=M01001&userId=xxx`（查詢會員卡）
  - GET `/api/cards?pageId=M01001`（查詢初始卡片）
  - POST `/api/cards`（儲存/更新卡片）
  - POST `/api/cards/pageview`（批次更新瀏覽數）
- [x] API 回傳格式、錯誤處理完善
- [x] 宣傳卡片關聯表 `promo_cards` 及排序機制完成

### 2. 前端欄位與圖片上傳
- [x] 所有欄位正確顯示、可編輯
- [x] 圖片上傳功能完整（Supabase Storage整合）
- [x] 欄位即時預覽、FLEX JSON 顯示正常
- [x] 多卡片排序與管理功能

### 3. 分享連結與 FLEX 產生邏輯
- [x] 分享連結正確（pageId+userId）
- [x] LIFF 自動分享流程完善
- [x] FLEX JSON 清理機制
- [x] PageView 統計機制完成

### 4. 多卡片/附加卡片管理
- [x] 多卡片資料結構設計完成
- [x] 前端 UI 支援卡片排序、編輯、管理
- [x] API 支援多卡片查詢/儲存
- [x] FLEX JSON 支援 carousel 結構

### 5. 核心bug修復
- [x] 編輯模式即時預覽問題
- [x] 自動分享主卡識別機制
- [x] PageView 更新邏輯優化
- [x] 宣傳卡片標識機制

---

## 🚀 **下階段開發計劃（2025-06-01 開始）**

### 第一階段：UI/UX 優化與 OG 預覽
#### 1. OG 預覽頁面強化（高優先級）
- [ ] Meta Tags 動態生成
  - Open Graph 標籤完善
  - Twitter Card 支援
  - 動態分享縮圖生成
- [ ] 社群分享預覽頁面
  - 分享標題與描述優化
  - 支援多平台分享預覽
  - 自訂分享圖片

#### 2. 頁面美化與 UX 提升（高優先級）
- [ ] 響應式設計優化
  - 手機版介面改善
  - 平板版介面優化
  - 跨裝置一致性
- [ ] 視覺設計提升
  - 配色方案統一
  - 動畫效果加入
  - 載入狀態優化
- [ ] 操作體驗改善
  - 表單驗證強化
  - 錯誤提示優化
  - 操作引導設計

### 第二階段：PageView 功能強化
#### 3. PageView 計算邏輯進階（中優先級）
- [ ] 瀏覽次數統計功能
  - 圖片載入統計
  - 頁面瀏覽統計
  - 去重機制設計
- [ ] 統計數據分析
  - 熱門卡片排行
  - 分享效果分析
  - 用戶行為追蹤
- [ ] 防刷機制
  - IP 限制
  - 時間間隔控制
  - 異常行為檢測

#### 4. 統計儀表板（中優先級）
- [ ] 後台管理介面
  - 卡片統計總覽
  - 分享數據圖表
  - 用戶活躍度分析
- [ ] 數據導出功能
  - Excel 報表匯出
  - API 數據接口
  - 定期報告生成

### 第三階段：進階功能開發
#### 5. 會員功能擴展（低優先級）
- [ ] 會員專屬功能
  - 個人圖片庫管理
  - 卡片模板系統
  - 分享歷史記錄
- [ ] 權限控管系統
  - 角色權限設計
  - API 權限驗證
  - 操作日誌記錄

#### 6. 效能優化與監控（低優先級）
- [ ] 效能優化
  - 圖片壓縮與CDN
  - API 響應時間優化
  - 資料庫查詢優化
- [ ] 監控與警報
  - 錯誤監控系統
  - 效能監控儀表板
  - 自動警報機制

---

## 📋 **技術債務清理**

### 程式碼品質提升
- [ ] 程式碼重構
  - 分享邏輯模組化
  - 共用函數抽取
  - 程式碼註解完善
- [ ] 測試覆蓋率提升
  - 單元測試撰寫
  - 整合測試設計
  - E2E 測試自動化

### 文檔與維護
- [ ] 技術文檔更新
  - API 文檔完善
  - 部署指南更新
  - 故障排除手冊
- [ ] 開發流程優化
  - CI/CD 流程改善
  - 程式碼審查機制
  - 版本發布流程

---

## 🏷️ **版本歷程**

### v20250531-final
- **成就**：核心功能完全穩定
- **特色**：編輯模式、自動分享、多卡片管理
- **狀態**：生產環境穩定運行

### v20250601-A（計劃中）
- **主要目標**：OG預覽頁面 + UI美化
- **預期功能**：社群分享優化、響應式設計

### v20250615-B（計劃中）
- **主要目標**：PageView進階功能
- **預期功能**：統計儀表板、防刷機制

---

## 💡 **開發建議**

### 技術選型建議
- **前端美化**：考慮使用 Tailwind CSS 或 Material-UI
- **圖表展示**：推薦 Chart.js 或 D3.js
- **動畫效果**：建議使用 Framer Motion

### 架構考量
- **微服務化**：統計功能可考慮獨立服務
- **快取策略**：Redis 快取熱門數據
- **CDN 整合**：圖片載入速度優化

### 安全性加強
- **資料加密**：敏感數據加密存儲
- **API 限流**：防止惡意請求
- **日誌監控**：完整操作追蹤

---

## 📱 **設備使用策略與架構指南**

### 🎯 設備分工明確

#### **手機設備**：
- ✅ **主要使用**：LIFF網頁 (`https://liff.line.me/2007327814-BdWpj70m`)
- ✅ **優勢**：LINE身份驗證、原生分享、完整功能
- ✅ **適用場景**：會員卡編輯、分享、查看

#### **電腦設備**：
- ✅ **選擇1**：SIMPLE網頁 (`https://barv3.vercel.app/member-card-simple.html`)
- ✅ **選擇2**：LIFF網頁（也可正常使用）
- ✅ **優勢**：大螢幕編輯、複雜操作、開發測試
- ✅ **適用場景**：管理員操作、批量編輯、系統維護

### 🔧 技術架構原則

#### **LIFF架構**
```
https://liff.line.me/2007327814-BdWpj70m
├─ ?pageId=M01001&userId=xxx  # 個人分享模式
├─ ?pageId=M01001             # 公開查看模式  
└─ (無參數)                   # 編輯模式
```

#### **SIMPLE架構**
```
https://barv3.vercel.app/member-card-simple.html
├─ ?pageId=M01001&userId=xxx  # 自動分享模式
├─ ?pageId=M01001             # 查看模式
└─ (無參數)                   # 編輯模式
```

### ⚠️ **重要開發教訓**

#### **🚨 切勿隨意修改分享邏輯**
> **教訓來源**：2025-06-04 多次修改導致分享功能破損
> 
> **具體問題**：
> - 修改分享按鈕URI導致404錯誤
> - 調整手機跳轉邏輯破壞原有分享機制
> - 增強錯誤診斷反而影響核心功能
> 
> **解決方案**：回復到穩定版本 `e91b86a`

#### **💡 核心功能保護原則**

1. **分享機制**：
   - ✅ 現有的LIFF分享邏輯已經穩定
   - ❌ 不要輕易修改分享按鈕的URI生成
   - ❌ 不要改變自動分享的參數結構

2. **設備檢測**：
   - ✅ 當前的設備使用分工已經明確
   - ❌ 不需要複雜的自動跳轉邏輯
   - ❌ 不要強制改變用戶的使用習慣

3. **預覽功能**：
   - ✅ 可以調整CSS來改善顯示效果
   - ❌ 不要修改FLEX渲染的核心邏輯
   - ❌ 不要改變flex2html的基本運作

#### **🛡️ 穩定版本保護策略**

**穩定版本基準**：
- `e915d6e` - v20250531-final：超穩定核心版本
- `e91b86a` - v20250531-final-fixed：穩定版本+儲存修復

**緊急回復流程**：
```bash
# 1. 回復到穩定版本
git reset --hard e91b86a

# 2. 強制推送覆蓋
git push -f origin master

# 3. 觸發部署
git commit --allow-empty -m "回復穩定版本"
git push origin master
```

### 🎯 **未來開發建議**

#### **安全開發原則**
1. **小步快跑**：每次只修改一個小功能
2. **充分測試**：修改後必須測試分享/儲存/預覽功能
3. **版本備份**：重要修改前先打tag保護穩定版本
4. **漸進改善**：優先修改CSS/樣式，避免修改核心邏輯

#### **功能擴展方向**
- ✅ **UI美化**：CSS樣式、響應式設計
- ✅ **預覽優化**：顯示效果、用戶體驗
- ✅ **統計功能**：PageView分析、數據報表
- ❌ **跳轉邏輯**：避免修改現有的設備分工
- ❌ **分享機制**：保持現有穩定的分享流程

---

## 🔄 **版本更新記錄**

### v20250604-preview-fix
- **成就**：修復預覽縮小80%問題
- **方法**：增加預覽區域尺寸，強制覆蓋flex2html縮放
- **效果**：FLEX消息100%正常呈現

### v20250604-rollback  
- **緊急處理**：回復到穩定版本e91b86a
- **原因**：URI修改和錯誤診斷破壞分享功能
- **教訓**：記錄核心功能保護原則

---

*最後更新：2025-06-04*  
*狀態：穩定版本 + 預覽優化*  
*重點：設備分工明確，核心功能穩定保護* 