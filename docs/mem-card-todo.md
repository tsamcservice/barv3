# 會員卡功能開發待辦（2025-06-05 預覽優化完成）

## 🎯 **重要技術突破：預覽區域優化技巧**

### **預覽不壓縮的關鍵技術（2025-06-05完成）**
經過多次測試和優化，成功解決了FLEX預覽在不同設備上的顯示問題：

#### **🔧 核心技術原理**
```css
/* 關鍵：固定寬度 + 防壓縮設定 */
#main-card-preview .chatbox {
    width: 550px; /* 固定寬度是關鍵！不使用min-width */
    flex-shrink: 0; /* 防止任何壓縮 */
    margin: 0; /* 移除auto居中，讓滑動正常 */
    transform: none; /* 防止任何變形 */
}

/* 容器支援滑動 */
#main-card-preview {
    overflow-x: auto; /* 或 scroll 強制顯示滑動條 */
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch; /* iOS優化 */
}
```

#### **📱 響應式設計策略**
- **手機直立**：容器全寬，chatbox固定550px，超出部分可滑動
- **手機橫放**：容器足夠容納550px，顯示完整無壓縮
- **平板/電腦**：容器600px，chatbox固定550px，組合卡片可滑動查看

#### **🎨 用戶體驗優化**
```css
/* 自訂滑動軌跡樣式 */
#main-card-preview::-webkit-scrollbar {
    height: 8px;
}
#main-card-preview::-webkit-scrollbar-thumb {
    background: #4caf50; /* 綠色主題 */
    border-radius: 4px;
}
```

#### **⚠️ 重要發現**
1. **寬度是關鍵**：固定寬度比彈性寬度更穩定
2. **手機橫放測試法**：橫放不壓縮證明寬度設定正確
3. **flex-shrink: 0**：防止flex容器自動縮放的必要設定
4. **margin: 0**：移除居中對齊，讓滑動功能正常運作

---

## ✅ **已完成功能** 

### 1. 資料庫與 API 基礎建置
- [x] 建立主表 `member_cards`，欄位完整實作
- [x] API 設計完成：
  - GET `/api/cards?pageId=M01001&userId=xxx`（查詢會員卡）
  - GET `/api/cards?pageId=M01001`（查詢初始卡片）
  - POST `/api/cards`（儲存/更新卡片）
  - POST `/api/cards/pageview`（批次更新瀏覽數）
- [x] API 回傳格式、錯誤處理完善
- [x] 宣傳卡片關聯表 `promo_cards` 及排序機制完成

### 2. 前端欄位與圖片上傳
- [x] 所有欄位正確顯示、可編輯
- [x] 圖片上傳功能完整（Supabase Storage整合）
- [x] 欄位即時預覽、FLEX JSON 顯示正常
- [x] 多卡片排序與管理功能
- [x] **2025-06-07新增**：圖片上傳統一化功能
  - 5個圖片區域功能統一（主圖、雪花動畫、行事曆、愛心、會員圖片）
  - 圖片尺寸自動檢測（PNG、JPEG、GIF支援）
  - 圖片資訊顯示（檔名、尺寸、檔案大小）
  - LINE頭貼整合機制
  - 圖片庫功能完全修復

### 3. 分享連結與 FLEX 產生邏輯
- [x] 分享連結正確（pageId+userId）
- [x] LIFF 自動分享流程完善
- [x] FLEX JSON 清理機制
- [x] PageView 統計機制完成

### 4. 多卡片/附加卡片管理
- [x] 多卡片資料結構設計完成
- [x] 前端 UI 支援卡片排序、編輯、管理
- [x] API 支援多卡片查詢/儲存
- [x] FLEX JSON 支援 carousel 結構

### 5. 核心bug修復
- [x] 編輯模式即時預覽問題
- [x] 自動分享主卡識別機制
- [x] PageView 更新邏輯優化
- [x] 宣傳卡片標識機制

---

## 🚀 **明日開發計劃（2025-06-08）**

### 📅 **今日成就記錄（2025-06-07）**
- ✅ 圖片庫功能完全修復
- ✅ UI介面簡化（按鈕文字、說明方式）
- ✅ 圖片上傳統一化（5個區域功能一致）
- ✅ 建立v20250607-FINAL穩定截點

### 📋 **明日三大開發目標**

#### 🎯 **目標1：MOBILE 響應式優化**（高優先級）
- [ ] 手機版介面全面優化
  - 表單欄位間距調整
  - 按鈕大小手機友好化
  - 圖片預覽區域響應式設計
- [ ] 圖片上傳手機體驗改善
  - 檔案選擇按鈕優化
  - 上傳進度提示
  - 預覽圖片尺寸調整
- [ ] 預覽區域手機適配
  - 卡片滑動優化
  - 觸控體驗改善

#### 🎯 **目標2：OG 預覽功能開發**（高優先級）
- [ ] Meta Tags 動態生成
  - Open Graph 標籤完善
  - 動態分享縮圖生成
  - 會員卡片資訊提取
- [ ] 社群分享預覽頁面
  - 分享標題與描述優化
  - 支援LINE、FB分享預覽
  - 自訂分享圖片功能

#### 🎯 **目標3：新增宣傳卡片頁面**（高優先級）
- [ ] 宣傳卡片管理介面
  - 新增宣傳卡片表單
  - 宣傳卡片預覽功能
  - 圖片上傳整合
- [ ] 宣傳卡片API擴展
  - 新增API設計
  - 資料庫結構確認
  - 權限控制機制

---

## 🚀 **後續開發計劃**

### 第一階段：UI/UX 優化與 OG 預覽（進行中）
#### 1. OG 預覽頁面強化（明日重點）
- [ ] Meta Tags 動態生成
- [ ] 社群分享預覽頁面
- [ ] 動態分享縮圖生成

#### 2. 響應式設計優化（明日重點）
- [ ] 手機版介面改善
- [ ] 平板版介面優化
- [ ] 跨裝置一致性

### 第二階段：PageView 功能強化
#### 3. PageView 計算邏輯進階（中優先級）
- [ ] 瀏覽次數統計功能
  - 圖片載入統計
  - 頁面瀏覽統計
  - 去重機制設計
- [ ] 統計數據分析
  - 熱門卡片排行
  - 分享效果分析
  - 用戶行為追蹤
- [ ] 防刷機制
  - IP 限制
  - 時間間隔控制
  - 異常行為檢測

#### 4. 統計儀表板（中優先級）
- [ ] 後台管理介面
  - 卡片統計總覽
  - 分享數據圖表
  - 用戶活躍度分析
- [ ] 數據導出功能
  - Excel 報表匯出
  - API 數據接口
  - 定期報告生成

### 第三階段：進階功能開發
#### 5. 會員功能擴展（低優先級）
- [ ] 會員專屬功能
  - 個人圖片庫管理
  - 卡片模板系統
  - 分享歷史記錄
- [ ] 權限控管系統
  - 角色權限設計
  - API 權限驗證
  - 操作日誌記錄

#### 6. 效能優化與監控（低優先級）
- [ ] 效能優化
  - 圖片壓縮與CDN
  - API 響應時間優化
  - 資料庫查詢優化
- [ ] 監控與警報
  - 錯誤監控系統
  - 效能監控儀表板
  - 自動警報機制

---

## 📋 **技術債務清理**

### 程式碼品質提升
- [ ] 程式碼重構
  - 分享邏輯模組化
  - 共用函數抽取
  - 程式碼註解完善
- [ ] 測試覆蓋率提升
  - 單元測試撰寫
  - 整合測試設計
  - E2E 測試自動化

### 文檔與維護
- [ ] 技術文檔更新
  - API 文檔完善
  - 部署指南更新
  - 故障排除手冊
- [ ] 開發流程優化
  - CI/CD 流程改善
  - 程式碼審查機制
  - 版本發布流程

---

## 🏷️ **版本歷程**

### v20250607-FINAL ⭐ **重要里程碑**
- **成就**：圖片上傳功能統一化完成，UI介面大幅簡化
- **核心突破**：
  - 修復圖片庫sizeText變數作用域問題
  - 圖片尺寸檢測功能上線（支援API自動檢測PNG、JPEG、GIF）
  - 統一5個圖片區域的上傳、預覽、選擇功能
  - LINE頭貼整合機制完成
- **UI優化**：
  - "選取已上傳" → "圖片庫" 按鈕文字優化
  - "?" 提示改為手機友好的灰色說明文字
  - 圖片資訊顯示：檔名、尺寸(999×999)、檔案大小
- **資料庫增強**：新增image_width、image_height欄位
- **狀態**：🟢 **圖片功能完全穩定，UI簡化完成，建議作為後續開發基準點**

### v20250605-FINAL ⭐ **預覽系統里程碑**
- **成就**：預覽系統完全穩定，跨設備顯示一致
- **核心突破**：解決FLEX預覽壓縮問題，實現550px固定寬度
- **技術創新**：響應式滑動設計，自訂滑動軌跡樣式
- **穩定基礎**：JavaScript編碼問題修復，回復到穩定版本
- **狀態**：🟢 **生產環境超穩定**

### v20250605-preview-enhanced
- **特色**：chatbox固定寬度550px，強化左右滑動功能
- **優化**：新增滑動軌跡樣式，優化響應式設計

### v20250604-preview-fix
- **特色**：修復預覽縮小80%問題，增加預覽區域尺寸
- **方法**：強制覆蓋flex2html縮放，實現100%正常呈現

### v20250531-final
- **成就**：核心功能完全穩定
- **特色**：編輯模式、自動分享、多卡片管理
- **狀態**：生產環境穩定運行

---

## 🚀 **後續開發路線圖（2025-06-05 制定）**

### 第一階段：系統穩定性強化 🔒
#### 1. RLS安全性優化（高優先級）
- [ ] 精細化RLS政策設計
  - 保持功能正常的前提下收緊權限
  - 匿名分享功能安全策略
  - API權限分級管理
- [ ] 資料庫安全評估
  - Security Advisor警告解決
  - 權限最小化原則實施
  - 審計日誌機制

#### 2. JavaScript編碼問題防護（高優先級）
- [ ] 開發環境穩定化
  - 建立Cursor更新前的備份機制
  - 文件編碼檢查工具
  - 自動化編碼驗證流程
- [ ] 版本控制策略
  - 重要功能點建立保護標籤
  - 快速回復機制完善
  - 編碼問題預警系統

### 第二階段：用戶體驗優化 📱
#### 3. 手機版簡化介面（中優先級）
- [ ] Mobile版本設計
  - 精簡操作流程
  - 大按鈕友好設計
  - 滑動操作優化
- [ ] 響應式體驗提升
  - 基於550px預覽技術
  - 手機橫/直放自適應
  - 觸控手勢支援

#### 4. OG預覽頁面開發（中優先級）
- [ ] 社群分享優化
  - Open Graph標籤完善
  - 動態分享縮圖生成
  - Twitter Card支援
- [ ] Meta Tags動態生成
  - 個人化分享內容
  - SEO優化
  - 多平台相容性

### 第三階段：功能擴展 🎮
#### 5. 會員活動卡系統（低優先級）
- [ ] 活動卡片管理
  - 時效性卡片設計
  - 活動參與統計
  - 獎勵機制整合
- [ ] 會員互動功能
  - 卡片收集系統
  - 成就徽章設計
  - 社群分享激勵

#### 6. UNITY整合開發（低優先級）
- [ ] 3D展覽館整合
  - WebGL嵌入設計
  - 會員卡3D呈現
  - 虛擬展覽體驗
- [ ] 跨平台整合
  - Unity與Web API整合
  - 資料同步機制
  - 用戶體驗一致性

---

## 📋 **開發優先級與時程規劃**

### 🔴 緊急項目（1-2週）
1. **RLS安全性**：解決Security Advisor警告
2. **編碼防護**：建立Cursor更新保護機制

### 🟡 重要項目（3-4週）
1. **Mobile簡化版**：基於550px預覽技術
2. **OG預覽頁面**：社群分享體驗提升

### 🟢 增值項目（5-8週）
1. **會員活動卡**：功能擴展與用戶黏性
2. **UNITY整合**：3D體驗與創新功能

---

## 💡 **開發建議**

### 技術選型建議
- **前端美化**：考慮使用 Tailwind CSS 或 Material-UI
- **圖表展示**：推薦 Chart.js 或 D3.js
- **動畫效果**：建議使用 Framer Motion

### 架構考量
- **微服務化**：統計功能可考慮獨立服務
- **快取策略**：Redis 快取熱門數據
- **CDN 整合**：圖片載入速度優化

### 安全性加強
- **資料加密**：敏感數據加密存儲
- **API 限流**：防止惡意請求
- **日誌監控**：完整操作追蹤

---

## 📱 **設備使用策略與架構指南**

### 🎯 設備分工明確

#### **手機設備**：
- ✅ **主要使用**：LIFF網頁 (`https://liff.line.me/2007327814-BdWpj70m`)
- ✅ **優勢**：LINE身份驗證、原生分享、完整功能
- ✅ **適用場景**：會員卡編輯、分享、查看

#### **電腦設備**：
- ✅ **選擇1**：SIMPLE網頁 (`https://barv3.vercel.app/member-card-simple.html`)
- ✅ **選擇2**：LIFF網頁（也可正常使用）
- ✅ **優勢**：大螢幕編輯、複雜操作、開發測試
- ✅ **適用場景**：管理員操作、批量編輯、系統維護

### 🔧 技術架構原則

#### **LIFF架構**
```
https://liff.line.me/2007327814-BdWpj70m
├─ ?pageId=M01001&userId=xxx  # 個人分享模式
├─ ?pageId=M01001             # 公開查看模式  
└─ (無參數)                   # 編輯模式
```

#### **SIMPLE架構**
```
https://barv3.vercel.app/member-card-simple.html
├─ ?pageId=M01001&userId=xxx  # 自動分享模式
├─ ?pageId=M01001             # 查看模式
└─ (無參數)                   # 編輯模式
```

### ⚠️ **重要開發教訓**

#### **🚨 切勿隨意修改分享邏輯**
> **教訓來源**：2025-06-04 多次修改導致分享功能破損
> 
> **具體問題**：
> - 修改分享按鈕URI導致404錯誤
> - 調整手機跳轉邏輯破壞原有分享機制
> - 增強錯誤診斷反而影響核心功能
> 
> **解決方案**：回復到穩定版本 `e91b86a`

#### **💡 核心功能保護原則**

1. **分享機制**：
   - ✅ 現有的LIFF分享邏輯已經穩定
   - ❌ 不要輕易修改分享按鈕的URI生成
   - ❌ 不要改變自動分享的參數結構

2. **設備檢測**：
   - ✅ 當前的設備使用分工已經明確
   - ❌ 不需要複雜的自動跳轉邏輯
   - ❌ 不要強制改變用戶的使用習慣

3. **預覽功能**：
   - ✅ 可以調整CSS來改善顯示效果
   - ❌ 不要修改FLEX渲染的核心邏輯
   - ❌ 不要改變flex2html的基本運作

#### **🛡️ 穩定版本保護策略**

**穩定版本基準**：
- `e915d6e` - v20250531-final：超穩定核心版本
- `e91b86a` - v20250531-final-fixed：穩定版本+儲存修復

**緊急回復流程**：
```bash
# 1. 回復到穩定版本
git reset --hard e91b86a

# 2. 強制推送覆蓋
git push -f origin master

# 3. 觸發部署
git commit --allow-empty -m "回復穩定版本"
git push origin master
```

### 🎯 **未來開發建議**

#### **安全開發原則**
1. **小步快跑**：每次只修改一個小功能
2. **充分測試**：修改後必須測試分享/儲存/預覽功能
3. **版本備份**：重要修改前先打tag保護穩定版本
4. **漸進改善**：優先修改CSS/樣式，避免修改核心邏輯

#### **功能擴展方向**
- ✅ **UI美化**：CSS樣式、響應式設計
- ✅ **預覽優化**：顯示效果、用戶體驗
- ✅ **統計功能**：PageView分析、數據報表
- ❌ **跳轉邏輯**：避免修改現有的設備分工
- ❌ **分享機制**：保持現有穩定的分享流程

---

## 🔄 **版本更新記錄**

### v20250607-IMAGE-LIB-FIXED ⭐ **重要修復**
- **成就**：圖片庫功能完全正常運作
- **問題**：解決SERVICE_ROLE_KEY在Vercel環境無法讀取的問題
- **方案**：改用ANON_KEY + 開放式RLS政策
- **技術突破**：
  - 診斷工具：testSimpleAPI(), testImageLibraryDeep()
  - 環境變數檢測機制
  - 完整的故障排除文檔
- **狀態**：🟢 **圖片庫功能完全穩定**

### v20250604-preview-fix
- **成就**：修復預覽縮小80%問題
- **方法**：增加預覽區域尺寸，強制覆蓋flex2html縮放
- **效果**：FLEX消息100%正常呈現

### v20250604-rollback  
- **緊急處理**：回復到穩定版本e91b86a
- **原因**：URI修改和錯誤診斷破壞分享功能
- **教訓**：記錄核心功能保護原則

## 🔧 **重要技術修復記錄**

### **SERVICE_ROLE_KEY環境變數問題（2025-06-07解決）**
- **問題**：Vercel環境無法正確讀取`SUPABASE_SERVICE_ROLE_KEY`
- **症狀**：圖片庫API返回HTTP 500錯誤
- **診斷**：`testSimpleAPI()`顯示`SERVICE_ROLE_KEY: false`
- **解決**：改用`NEXT_PUBLIC_SUPABASE_ANON_KEY` + 開放RLS政策
- **預防**：建立環境變數檢測機制，創建故障排除指南

---

*最後更新：2025-06-07*  
*狀態：圖片庫功能完全修復 + 預覽系統穩定*  
*重點：環境變數問題解決，完整的調試工具建立* 