# 20250707 簡單分流模式實施記錄

## 📅 實施日期：2025年7月7日
## 🎯 目標：解決新會員預覽問題，實施簡單分流模式

---

## 🔧 **修改內容**

### 1. **修改 `loadUserCardDataFast()` 函數**
- **位置**：`public/js/mcard-mtest.js` 第4932行
- **修改內容**：
  - 添加新舊會員分流邏輯
  - 新會員：隱藏宣傳卡片相關頁面，直接進入預覽
  - 舊會員：保持原有完整流程

### 2. **新增 `hidePromoCardSections()` 函數**
- **位置**：`public/js/mcard-mtest.js` 第5017行
- **功能**：隱藏宣傳卡片選擇器、排序區域等相關頁面

### 3. **新增 `shareForNewUser()` 函數**
- **位置**：`public/js/mcard-mtest.js` 第5042行
- **功能**：新會員專用的簡化分享功能，不涉及點數計算

### 4. **修改 `switchTab()` 函數**
- **位置**：`public/js/mcard-mtest.js` 第5290行
- **修改內容**：
  - 添加新會員模式檢測
  - 新會員：直接渲染主卡預覽
  - 舊會員：保持完整預覽流程

### 5. **修改 `shareToLine()` 函數**
- **位置**：`public/js/mcard-mtest.js` 第2719行
- **修改內容**：
  - 添加新舊會員分流邏輯
  - 新會員：使用 `shareForNewUser()`
  - 舊會員：保持原有完整分享流程

---

## 🎯 **分流邏輯**

### **新會員流程：**
1. 檢查資料庫是否有記錄
2. 無記錄 → 進入簡化模式
3. 隱藏宣傳卡片相關頁面
4. 直接載入 M01001 初始資料 + LINE 個人資料
5. 自動切換到預覽頁面
6. 使用簡化分享功能

### **舊會員流程：**
1. 檢查資料庫是否有記錄
2. 有記錄 → 進入完整模式
3. 保持所有原有功能（宣傳卡片、排序、點數等）
4. 使用完整分享流程

---

## 🔍 **檢測機制**

### **新會員模式檢測：**
```javascript
const promoSelector = document.getElementById('promo-card-selector');
const isNewUserMode = promoSelector && promoSelector.style.display === 'none';
```

### **關鍵判斷點：**
- 資料庫查詢結果：`result.data.length > 0`
- 宣傳卡片區域顯示狀態：`promoSelector.style.display === 'none'`

---

## 📋 **回滾方案**

### **如果需要回滾，可以：**
1. 恢復 `loadUserCardDataFast()` 函數到原始版本
2. 移除 `hidePromoCardSections()` 和 `shareForNewUser()` 函數
3. 恢復 `switchTab()` 和 `shareToLine()` 函數到原始版本

### **回滾步驟：**
```bash
# 如果使用 Git
git checkout HEAD~1 -- public/js/mcard-mtest.js
```

---

## 🧪 **測試建議**

### **新會員測試：**
1. 使用新的 LINE 帳號登入
2. 確認直接進入預覽頁面
3. 確認宣傳卡片相關頁面被隱藏
4. 測試簡化分享功能

### **舊會員測試：**
1. 使用已有資料的 LINE 帳號登入
2. 確認所有功能正常（宣傳卡片、排序、點數等）
3. 確認完整分享流程正常

---

## 📊 **預期效果**

### **新會員：**
- ✅ 直接看到預覽頁面
- ✅ 宣傳卡片相關功能被隱藏
- ✅ 預覽正常顯示
- ✅ 簡化分享功能正常

### **舊會員：**
- ✅ 保持所有原有功能
- ✅ 宣傳卡片、排序功能正常
- ✅ 點數計算正常
- ✅ 完整分享流程正常

---

## 🎯 **成功指標**

1. ✅ 新會員不再出現「正在載入您的會員卡...」一直顯示的問題
2. ✅ 新會員能正常預覽卡片
3. ✅ 舊會員功能完全不受影響
4. ✅ 分享功能在新舊會員模式下都正常運作

---

**實施狀態**：✅ 已完成
**測試狀態**：⏳ 待測試
**部署狀態**：⏳ 待部署 