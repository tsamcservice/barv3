# é»æ•¸ç³»çµ±ä¿®æ­£ç¸½çµ - 2025/01/27

## ğŸ¯ **ä¿®æ­£ç›®æ¨™**
è§£æ±ºé»æ•¸ç³»çµ±ä¸­äº¤æ˜“è¨˜éŒ„èˆ‡è³‡æ–™åº«ä¸åŒæ­¥çš„å•é¡Œï¼Œç¢ºä¿æ•¸æ“šä¸€è‡´æ€§ã€‚

## ğŸ” **å•é¡Œåˆ†æ**

### **æ ¸å¿ƒå•é¡Œ**
1. **äº¤æ˜“è¨˜éŒ„èµ·å§‹é»éŒ¯èª¤** - æ¯æ¬¡éƒ½å¾åˆå§‹è¨­å®šé–‹å§‹ï¼Œè€Œéå¯¦éš›é¤˜é¡
2. **è³‡æ–™åº«æ›´æ–°ä¸åŒæ­¥** - å½ˆè·³è¦–çª—æ­£ç¢ºä½†æœ€çµ‚è¨˜éŒ„éŒ¯èª¤  
3. **ç¼ºå°‘ç®¡ç†å“¡èª¿æ•´è¨˜éŒ„** - æ‰‹å‹•èª¿æ•´æ²’æœ‰äº¤æ˜“è¨˜éŒ„
4. **Adminé é¢é–ƒç¾168** - è¼‰å…¥é †åºå•é¡Œ

### **å•é¡Œæ ¹æº**
å¾Œç«¯APIï¼ˆpageview.js, simple-points.js, points.js, index.jsï¼‰åœ¨è™•ç†è‡¨æ™‚ä¸»å¡æ™‚ï¼Œä½¿ç”¨å›ºå®šçš„åˆå§‹è¨­å®šå€¼è€Œéç”¨æˆ¶å¯¦éš›é»æ•¸ã€‚

## âœ… **ä¿®æ­£å…§å®¹**

### **1. å¾Œç«¯APIä¿®æ­£**

#### **pageview.js - æ ¸å¿ƒä¿®æ­£**
```javascript
// ğŸ”§ ä¿®æ­£å‰ï¼šå›ºå®šä½¿ç”¨åˆå§‹è¨­å®š
const tempCurrentPoints = 168;

// âœ… ä¿®æ­£å¾Œï¼šå„ªå…ˆè®€å–ç”¨æˆ¶å¯¦éš›é»æ•¸
const { data: userData } = await supabase
  .from('member_cards')
  .select('user_points')
  .eq('line_user_id', userId)
  .eq('pageId', 'M01001')
  .single();

if (!userError && userData && userData.user_points !== null) {
  tempCurrentPoints = userData.user_points; // ä½¿ç”¨å¯¦éš›é¤˜é¡
} else {
  // æ–°ç”¨æˆ¶æ‰ä½¿ç”¨åˆå§‹è¨­å®š
  tempCurrentPoints = configData.config_value;
}
```

#### **simple-points.js, points.js, index.js**
- æ‰€æœ‰APIçµ±ä¸€æ”¹ç‚ºå¾ `points_config` è¡¨å‹•æ…‹è®€å–åˆå§‹é»æ•¸
- ä¿ç•™168ä½œç‚ºæœ€çµ‚fallback

### **2. ç®¡ç†å“¡èª¿æ•´æ·»åŠ äº¤æ˜“è¨˜éŒ„**

#### **users/points.js - æ–°å¢äº¤æ˜“è¨˜éŒ„**
```javascript
// ğŸ†• ç‚ºç®¡ç†å“¡èª¿æ•´å‰µå»ºäº¤æ˜“è¨˜éŒ„
await supabase.from('points_transactions').insert({
  card_id: currentData.id,
  card_type: 'main',
  transaction_type: 'admin_adjust', // æ–°çš„äº¤æ˜“é¡å‹
  amount: pointsAdjustment,
  balance_before: oldPoints,
  balance_after: newPoints,
  share_session_id: shareSessionId
});
```

### **3. Adminé é¢å„ªåŒ–**

#### **admin-points.html - ä¿®æ­£é–ƒç¾å•é¡Œ**
```javascript
// ğŸ”§ è¼‰å…¥å‰é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ï¼Œé¿å…168é–ƒç¾
initialPointsInput.value = '';
initialPointsInput.placeholder = 'è¼‰å…¥ä¸­...';
initialPointsInput.disabled = true;
```

### **4. è³‡æ–™åº«æ¶æ§‹**

#### **points_configè¡¨**
```sql
CREATE TABLE points_config (
    id SERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value INTEGER NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **äº¤æ˜“é¡å‹æ“´å±•**
- `deduct_share` - åˆ†äº«æ‰£é»
- `reward_share` - åˆ†äº«å›é¥‹  
- `admin_adjust` - ç®¡ç†å“¡èª¿æ•´ (æ–°å¢)
- `reward_auto_share` - è‡ªå‹•åˆ†äº«å›é¥‹

## ğŸ”§ **æŠ€è¡“æ”¹å–„**

### **é‚è¼¯æµç¨‹å„ªåŒ–**
1. **åˆ†äº«æ™‚**ï¼šå¯¦éš›é¤˜é¡ â†’ æ‰£é™¤ â†’ å›é¥‹è¨ˆç®— â†’ æ›´æ–°é¤˜é¡
2. **ç®¡ç†å“¡èª¿æ•´**ï¼šæŸ¥è©¢é¤˜é¡ â†’ å‰µå»ºäº¤æ˜“è¨˜éŒ„ â†’ æ›´æ–°é¤˜é¡
3. **æ–°ç”¨æˆ¶å‰µå»º**ï¼šä½¿ç”¨å‹•æ…‹åˆå§‹é»æ•¸è¨­å®š

### **æ•¸æ“šä¸€è‡´æ€§ç¢ºä¿**
- `member_cards.user_points` â†” `points_transactions.balance_after`
- æ¯æ¬¡äº¤æ˜“éƒ½åŸºæ–¼å¯¦éš›é¤˜é¡è¨ˆç®—
- æ‰€æœ‰é»æ•¸è®Šå‹•éƒ½æœ‰å®Œæ•´è¨˜éŒ„

## ğŸ“Š **è§£æ±ºçš„å•é¡Œ**

### **âœ… å·²ä¿®æ­£**
1. **äº¤æ˜“è¨˜éŒ„èµ·å§‹é»æ­£ç¢º** - ä½¿ç”¨å¯¦éš›é¤˜é¡è€Œéå›ºå®šå€¼
2. **è³‡æ–™åº«åŒæ­¥ä¸€è‡´** - å½ˆè·³è¦–çª—å’Œæœ€çµ‚è¨˜éŒ„ç›¸ç¬¦
3. **ç®¡ç†å“¡èª¿æ•´æœ‰è¨˜éŒ„** - admin_adjusté¡å‹äº¤æ˜“
4. **Adminé é¢ä¸é–ƒç¾** - ç›´æ¥é¡¯ç¤ºæ­£ç¢ºå€¼
5. **æ‰€æœ‰APIçµ±ä¸€é‚è¼¯** - å‹•æ…‹è®€å–åˆå§‹é»æ•¸

### **ğŸ¯ æ¸¬è©¦çµæœ**
- åˆ†äº«ä¸å†å¾200é‡è¤‡é–‹å§‹ï¼Œè€Œæ˜¯å¾å¯¦éš›é¤˜é¡é–‹å§‹
- äº¤æ˜“è¨˜éŒ„balance_before/afterå®Œå…¨æº–ç¢º
- ç®¡ç†å“¡èª¿æ•´æœƒåŒæ­¥å‰µå»ºäº¤æ˜“è¨˜éŒ„
- æ•¸æ“šå®Œå…¨åŒæ­¥ï¼Œç„¡ä¸ä¸€è‡´å•é¡Œ

## âš ï¸ **æ³¨æ„äº‹é …**

### **éƒ¨ç½²è¦æ±‚**
1. åŸ·è¡Œ `supabase/create-points-config-table.sql`
2. ç¢ºä¿RLSæ”¿ç­–æ­£ç¢ºè¨­å®š
3. é©—è­‰æ‰€æœ‰APIç«¯é»æ­£å¸¸é‹ä½œ

### **ç›£æ§é‡é»**
- äº¤æ˜“è¨˜éŒ„çš„balance_beforeæ˜¯å¦ä½¿ç”¨å¯¦éš›é¤˜é¡
- ç®¡ç†å“¡èª¿æ•´æ˜¯å¦å‰µå»ºå°æ‡‰äº¤æ˜“è¨˜éŒ„
- æ–°ç”¨æˆ¶æ˜¯å¦ä½¿ç”¨æ­£ç¢ºçš„åˆå§‹é»æ•¸

## ğŸš€ **å¾ŒçºŒé–‹ç™¼**

### **å¯èƒ½çš„å¢å¼·**
- æ‰¹æ¬¡é»æ•¸èª¿æ•´åŠŸèƒ½
- é»æ•¸äº¤æ˜“å ±è¡¨
- ç•°å¸¸äº¤æ˜“ç›£æ§
- é»æ•¸é¤˜é¡æ ¡é©—å·¥å…·

---

**ä¿®æ­£å®Œæˆæ—¥æœŸ**ï¼š2025/01/27  
**å½±éŸ¿ç¯„åœ**ï¼šMTESTã€MOBILEã€Adminç®¡ç†é é¢  
**æ¸¬è©¦ç‹€æ…‹**ï¼šâœ… å·²é©—è­‰æ•¸æ“šåŒæ­¥æ­£å¸¸ 